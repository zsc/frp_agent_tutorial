<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 3ï½œæ ¸å¿ƒè¿è¡Œæ—¶ï¼šAgent ä½œä¸ºâ€œå¯ç»„åˆçš„ååº”ç³»ç»Ÿâ€</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ FRPï¼ˆFunctional Reactive Programmingï¼‰æ­å»º LLM å®æ—¶ Agentï¼šä»æŠ½è±¡åˆ°è½åœ°ã€‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1ï½œé—®é¢˜ç©ºé—´ä¸æ€»ä½“æ¶æ„ï¼šä¸ºä»€ä¹ˆç”¨ FRP</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2ï½œFRP åŸºç¡€ï¼šç”¨äº‹ä»¶æµæè¿° Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3ï½œæ ¸å¿ƒè¿è¡Œæ—¶ï¼šAgent ä½œä¸ºâ€œå¯ç»„åˆçš„ååº”ç³»ç»Ÿâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4ï½œPrompt Managementï¼šå†…åµŒç¯å¢ƒçŠ¶æ€æ’­æŠ¥ + æ—¶é—´å˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5ï½œç”¨æˆ·å¼‚æ­¥åŠ¨ä½œï¼šæ‰“æ–­ã€æ’¤å›ã€æ”¹å£ã€å¤šæ¨¡æ€è¾“å…¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6ï½œå·¥å…· / API è°ƒç”¨ï¼šå¤±æ•ˆå¤„ç†ã€å›é€€ã€å¹‚ç­‰ä¸éš”ç¦»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7ï½œRAG / DB / Python toolcallï¼šæŠŠçŸ¥è¯†ç®¡é“å˜æˆäº‹ä»¶æµ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8ï½œSpeculative Exec & Speculative Decodingï¼šè®©ç³»ç»Ÿâ€œæ›´å¿«ä¹Ÿæ›´ç¨³â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9ï½œDynamic Batching & å¹¶å‘ï¼šååã€å»¶è¿Ÿä¸å…¬å¹³æ€§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[Chapter 10ï½œäº‹ä»¶è§¦å‘å™¨ï¼šåšä¸€ä¸ªâ€œç±»ä¼¼ VADâ€çš„ Agent Trigger System](chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11ï½œRace Condition ä¸ä¸€è‡´æ€§ï¼šå¹¶å‘ä¸–ç•Œçš„â€œçœŸç›¸ç»´æŠ¤â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12ï½œToken Budget æ§åˆ¶ï¼šé¢„ç®—å°±æ˜¯äº§å“ä½“éªŒ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13ï½œæ—¥å¿—æŒä¹…åŒ–ä¸å¯è§‚æµ‹æ€§ï¼šTracing/Replay/Metric ä¸€ä½“åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14ï½œäººç±»ç›´è§‚ UIï¼ˆå«éŸ³æ•ˆï¼‰ä¸åå° Debug å¯è§†åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 15ï½œå®‰å…¨ã€éšç§ä¸æ²»ç†ï¼šè®© Agent å¯ä¸Šçº¿ã€å¯åˆè§„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 16ï½œè¯„æµ‹ä¸æŒç»­è¿­ä»£ï¼šä»â€œèƒ½ç”¨â€åˆ°â€œå¥½ç”¨â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 17ï½œå‚è€ƒå®ç°ï¼šä¸€ä¸ªç«¯åˆ°ç«¯çš„ FRP Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Aï½œæœ¯è¯­è¡¨ & FRP ç®—å­é€ŸæŸ¥ (The Agent Developer's Rosetta Stone)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Bï½œæ•°æ®ç»“æ„ä¸åè®®ï¼šEvent/State/Receipt/Trace Schema</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Cï½œæµ‹è¯•æ–¹æ³•ï¼šè™šæ—¶é—´ã€å›æ”¾ä¸æ··æ²Œå·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Dï½œéƒ¨ç½²ä¸è¿ç»´ï¼šé…ç½®ã€ç°åº¦ã€å‘Šè­¦ä¸å®¹ç¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-3agent">Chapter 3ï½œæ ¸å¿ƒè¿è¡Œæ—¶ï¼šAgent ä½œä¸ºâ€œå¯ç»„åˆçš„ååº”ç³»ç»Ÿâ€</h1>
<h2 id="31-runtime">3.1 å¼€ç¯‡ï¼šRuntime çš„èŒè´£è¾¹ç•Œâ€”â€”ä»â€œè„šæœ¬â€åˆ°â€œå¼•æ“â€</h2>
<p>åœ¨ç®€å•çš„ Demo ä¸­ï¼ŒAgent å¯èƒ½åªæ˜¯ä¸€ä¸ª <code>while(true)</code> å¾ªç¯é‡Œçš„ä¸€å † Python å‡½æ•°è°ƒç”¨ã€‚ä½†åœ¨ç”Ÿäº§çº§çš„å®æ—¶ç³»ç»Ÿä¸­ï¼Œè¿™ç§å†™æ³•ä¼šè¿…é€Ÿå´©æºƒï¼šå®ƒæ— æ³•ä¼˜é›…åœ°å¤„ç†ç”¨æˆ·æ‰“æ–­ã€ç½‘ç»œè¶…æ—¶ã€å¹¶å‘å·¥å…·è°ƒç”¨æˆ– Token é¢„ç®—è¶…æ ‡ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ª <strong>FRP Runtimeï¼ˆè¿è¡Œæ—¶ï¼‰</strong>ã€‚</p>
<p>å¦‚æœæŠŠ Agent çš„ Prompt å’Œç­–ç•¥é€»è¾‘æ¯”ä½œ<strong>æ¸¸æˆè„šæœ¬</strong>ï¼Œé‚£ä¹ˆ Runtime å°±æ˜¯<strong>æ¸¸æˆå¼•æ“</strong>ã€‚
æ¸¸æˆå¼•æ“è´Ÿè´£ç‰©ç†ç¢°æ’ã€æ¸²æŸ“å¾ªç¯ã€è¾“å…¥æ˜ å°„ï¼›åŒç†ï¼ŒAgent Runtime è´Ÿè´£å°†æ··æ²Œçš„ç°å®ä¸–ç•ŒæŠ½è±¡ä¸ºæœ‰åºçš„æµã€‚</p>
<p><strong>Runtime çš„æ ¸èŒè´£çŸ©é˜µ</strong>ï¼š</p>
<p>| é¢†åŸŸ | èŒè´£æè¿° | å…¸å‹é—®é¢˜ç¤ºä¾‹ |</p>
<table>
<thead>
<tr>
<th style="text-align: left;">é¢†åŸŸ</th>
<th style="text-align: left;">èŒè´£æè¿°</th>
<th style="text-align: left;">å…¸å‹é—®é¢˜ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>I/O å½’ä¸€åŒ–</strong></td>
<td style="text-align: left;">å°† HTTP/WebSocket/Timer ç»Ÿä¸€ä¸º Event</td>
<td style="text-align: left;">"ç”¨æˆ·è¯´è¯"å’Œ"å®šæ—¶å™¨åˆ°æœŸ"åº”è¯¥æ˜¯ä¸€å›äº‹å—ï¼Ÿ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>æ—¶ç©ºç®¡ç†</strong></td>
<td style="text-align: left;">ç»´æŠ¤é€»è¾‘æ—¶é’Ÿä¸ç‰©ç†æ—¶é’Ÿçš„æ˜ å°„</td>
<td style="text-align: left;">"ç°åœ¨"æ˜¯å‡ ç‚¹ï¼Ÿé‡æ”¾æ˜¨å¤©çš„æ•°æ®æ—¶ï¼Œ"ç°åœ¨"æ˜¯æ˜¨å¤©ã€‚</td>
</tr>
<tr>
<td style="text-align: left;"><strong>çŠ¶æ€æŠ¤æ </strong></td>
<td style="text-align: left;">ä¿è¯ State çš„åŸå­æ€§ä¸ä¸€è‡´æ€§</td>
<td style="text-align: left;">ä¸¤ä¸ªå·¥å…·åŒæ—¶è¿”å›ç»“æœï¼Œè°å…ˆè°åï¼Ÿè°è¦†ç›–è°ï¼Ÿ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å‰¯ä½œç”¨æ‰˜ç®¡</strong></td>
<td style="text-align: left;">éš”ç¦»å¹¶è°ƒåº¦æ‰€æœ‰å¤–éƒ¨è°ƒç”¨ (Effect)</td>
<td style="text-align: left;">ç”¨æˆ·è¿™å¥ä¸è¯´äº†ï¼Œåå°æ­£åœ¨è·‘çš„ SQL æŸ¥è¯¢è¦æ€æ‰å—ï¼Ÿ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å¯è§‚æµ‹æ€§</strong></td>
<td style="text-align: left;">æä¾›â€œä¸Šå¸è§†è§’â€çš„ Trace ä¸Šä¸‹æ–‡</td>
<td style="text-align: left;">è¿™ä¸€æ­¥æ¨ç†ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿæ˜¯æ¨¡å‹æ…¢è¿˜æ˜¯ç½‘ç»œå¡ï¼Ÿ</td>
</tr>
</tbody>
</table>
<p>æœ¬ç« å°†è¯¦ç»†è§£æ„è¿™ä¸ªå¼•æ“çš„å†…éƒ¨æ„é€ ã€‚</p>
<hr />
<h2 id="32">3.2 â€œä¸€åˆ‡çš†äº‹ä»¶â€ï¼šå½’ä¸€åŒ–è¾“å…¥ä¸äº‹ä»¶æ€»çº¿</h2>
<p>åœ¨ FRP æ¶æ„ä¸­ï¼Œ<strong>æ²¡æœ‰â€œè°ƒç”¨â€ï¼Œåªæœ‰â€œäº‹ä»¶â€</strong>ã€‚
ä¼ ç»Ÿçš„ Request/Response æ¨¡å‹æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œè€Œ Event Stream æ¨¡å‹å¼‚æ­¥éé˜»å¡çš„ã€‚</p>
<h3 id="321-the-universal-envelope">3.2.1 é€šç”¨äº‹ä»¶ä¿¡å° (The Universal Envelope)</h3>
<p>ä¸ºäº†è®© Runtime èƒ½å¤„ç†ä»»ä½•ç±»å‹çš„è¾“å…¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å‡†åŒ–çš„â€œä¿¡å°â€ã€‚æ‰€æœ‰è¿›å…¥ç³»ç»Ÿçš„æ•°æ®åŒ…ï¼Œå¿…é¡»å…ˆè¢«å°è£…ã€‚</p>
<div class="codehilite"><pre><span></span><code>Structure: StandardEvent &lt;T&gt;
-----------------------------------------------------------------------
| Field          | Description                                        |
-----------------------------------------------------------------------
| id             | UUID v4 (å”¯ä¸€æ ‡è¯†)                                 |
| sequence_id    | é€»è¾‘æ—¶é’Ÿåºå· (å•è°ƒé€’å¢ï¼Œç”¨äºæ’åºä¸å»é‡)               |
| type           | äº‹ä»¶ç±»å‹æšä¸¾ (e.g. USER_INPUT, SYSTEM_TICK, TOOL_OK) |
| timestamp      | ç‰©ç†ç”Ÿæˆæ—¶é—´ (ISO8601)                               |
| payload        | æ³›å‹æ•°æ® T (å®é™…å†…å®¹)                                |
| trace_context  | åˆ†å¸ƒå¼è¿½è¸ª ID (TraceID, SpanID, ParentID)            |
| source         | äº‹ä»¶æ¥æº (UI, Timer, Worker-A)                       |
-----------------------------------------------------------------------
</code></pre></div>

<h3 id="322">3.2.2 äº‹ä»¶åˆ†ç±»å­¦</h3>
<p>Runtime å†…éƒ¨å¤„ç†çš„äº‹ä»¶è¿œä¸æ­¢â€œç”¨æˆ·è¾“å…¥â€å’Œâ€œæ¨¡å‹è¾“å‡ºâ€ã€‚æˆ‘ä»¬éœ€è¦å¤„ç†å››å¤§ç±»äº‹ä»¶æµï¼š</p>
<ol>
<li>
<p><strong>äº¤äº’æµ (Interaction Stream)</strong>:</p>
<ul>
<li><code>UserAudioChunkEvent</code>: åŸå§‹éŸ³é¢‘å¸§ï¼ˆé«˜é¢‘ï¼‰ã€‚</li>
<li><code>UserTextEvent</code>: ASR è½¬å½•åçš„æ–‡æœ¬æˆ–æ‰“å­—å†…å®¹ã€‚</li>
<li><code>UserIntentEvent</code>: UI äº¤äº’ï¼Œå¦‚ç‚¹å‡»â€œæš‚åœâ€ã€â€œé‡æ–°ç”Ÿæˆâ€ã€‚</li>
</ul>
</li>
<li>
<p><strong>ç³»ç»Ÿæµ (System Stream)</strong>:</p>
<ul>
<li><code>TickEvent</code>: å¿ƒè·³ï¼Œæºå¸¦ <code>delta_time</code>ï¼Œé©±åŠ¨å€’è®¡æ—¶å’Œè¶…æ—¶é€»è¾‘ã€‚</li>
<li><code>LifeCycleEvent</code>: <code>START</code>, <code>SHUTDOWN</code>, <code>SLEEP</code>ã€‚</li>
<li><code>ConnectivityEvent</code>: ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼ŒWebSocket æ–­å¼€/é‡è¿ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ¨¡å‹ä¸å·¥å…·æµ (Computation Stream)</strong>:</p>
<ul>
<li><code>ModelTokenEvent</code>: LLM åå‡ºçš„æµå¼ Tokenã€‚</li>
<li><code>ToolReceiptEvent</code>: å·¥å…·æ‰§è¡Œå®Œæˆçš„å›æ‰§ï¼ˆå«ç»“æœæˆ–é”™è¯¯æ ˆï¼‰ã€‚</li>
<li><code>BudgetAlarmEvent</code>: Token é¢„ç®—è€—å°½å‘Šè­¦ã€‚</li>
</ul>
</li>
<li>
<p><strong>æˆæµ (Synthetic Stream)</strong>:</p>
<ul>
<li><code>VADTriggerEvent</code>: è¯­éŸ³æ´»åŠ¨æ£€æµ‹è§¦å‘ï¼ˆç”¨æˆ·å¼€å§‹è¯´è¯/åœæ­¢è¯´è¯ï¼‰ã€‚</li>
<li><code>SilenceTimeoutEvent</code>: ç”¨æˆ·æ²‰é»˜è¶…æ—¶ï¼ˆBot ä¸»åŠ¨æ­è¯ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p><strong>æ¶æ„å›¾ï¼šäº‹ä»¶æ¼æ–—</strong></p>
<div class="codehilite"><pre><span></span><code>[WebSocket] --\
[Timer API] ----\
[HTTP Hook] ------+--&gt; [Ingress Adapters] --&gt; [Event Normalizer]
[Microphone] ---/            (Raw Data)       (Add Timestamp/ID)
                                                      |
                                                      v
                                               [Main Event Bus]
                                              (The Central Stream)
</code></pre></div>

<hr />
<h2 id="33-agentstate">3.3 AgentState è®¾è®¡ï¼šçŠ¶æ€æ ‘ä¸ä¸å¯å˜æ€§</h2>
<p>çŠ¶æ€ï¼ˆStateï¼‰æ˜¯ Agent çš„â€œè®°å¿†â€ã€‚åœ¨ FRP ä¸­ï¼ŒState æ˜¯ Stream ç»è¿‡ <code>scan</code> (accumulate) ç®—å­äº§ç”Ÿçš„ <strong>Signal</strong>ã€‚</p>
<h3 id="331">3.3.1 çŠ¶æ€æ ‘ç»“æ„</h3>
<p>ä¸è¦æŠŠæ‰€æœ‰ä¸œè¥¿å¡è¿›ä¸€ä¸ªæ‰å¹³çš„å­—å…¸ã€‚æ¨èä½¿ç”¨<strong>ç»„åˆå¼çŠ¶æ€æ ‘</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>AgentState (Root)
â”œâ”€â”€ Meta
â”‚   â”œâ”€â”€ SessionID
â”‚   â”œâ”€â”€ StartTime
â”‚   â””â”€â”€ LastActiveTime
â”œâ”€â”€ Environment (ç¯å¢ƒæ„ŸçŸ¥)
â”‚   â”œâ”€â”€ SystemTime
â”‚   â”œâ”€â”€ UserLocation
â”‚   â””â”€â”€ DeviceStatus
â”œâ”€â”€ Conversation (æ ¸å¿ƒä¼šè¯)
â”‚   â”œâ”€â”€ History (æ¶ˆæ¯åˆ—è¡¨)
â”‚   â”œâ”€â”€ CurrentTurn (å½“å‰è½®æ¬¡è‰ç¨¿)
â”‚   â””â”€â”€ ContextSummary (é•¿è®°å¿†æ‘˜è¦)
â”œâ”€â”€ RuntimeStatus (æ§åˆ¶é¢)
â”‚   â”œâ”€â”€ Stage (Idle / Listening / Thinking / Speaking)
â”‚   â”œâ”€â”€ PendingEffects (æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨åˆ—è¡¨)
â”‚   â””â”€â”€ TokenUsage (ç´¯è®¡æ¶ˆè€—)
â””â”€â”€ Buffer (ç¼“å†²åŒº)
    â””â”€â”€ PartialInput (å°šæœªæäº¤çš„ç”¨æˆ·è¾“å…¥ç‰‡æ®µ)
</code></pre></div>

<h3 id="332-immutable">3.3.2 ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ä¸å¯å˜ (Immutable)ï¼Ÿ</h3>
<p>åœ¨ JavaScript/TypeScript ä¸­å¯èƒ½ä½¿ç”¨ Immer.jsï¼Œåœ¨ Python ä¸­ä½¿ç”¨ Pydantic çš„ <code>frozen=True</code> æˆ– <code>dataclasses(frozen=True)</code>ã€‚</p>
<ol>
<li><strong>æ¯”è¾ƒï¼ˆDiffingï¼‰æ•ˆç‡</strong>ï¼šReact å¼çš„ UI æ›´æ–°ä¾èµ–äºå¼•ç”¨æ¯”è¾ƒ (<code>oldState !== newState</code>)ã€‚å¦‚æœæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç»˜ UI æå…¶å¿«</li>
<li><strong>å¹¶å‘å®‰å…¨</strong>ï¼šç”±äºæ—§çŠ¶æ€ä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ­£åœ¨è¯»å–æ—§çŠ¶æ€ç”¨äºæ¸²æŸ“æˆ–æ—¥å¿—çš„çº¿ç¨‹ä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚</li>
<li><strong>å†å²å›æº¯</strong>ï¼šä¿å­˜ <code>State</code> å¯¹è±¡çš„å¼•ç”¨åˆ—è¡¨ï¼Œå³è‡ªåŠ¨è·å¾—äº†â€œæ’¤é”€/é‡åšâ€åŠŸèƒ½ã€‚</li>
</ol>
<hr />
<h2 id="34-reducer">3.4 Reducer è§„èŒƒï¼šçº¯å‡½æ•°æ ¸å¿ƒ</h2>
<p>Reducer æ˜¯ Runtime çš„å¿ƒè„ã€‚å®ƒå®šä¹‰äº†ï¼š<strong>å½“å‘ç”Ÿ X æ—¶ï¼Œå¦‚æœå½“å‰å¤„äº Y çŠ¶æ€ï¼Œé‚£ä¹ˆå˜æˆ Z çŠ¶æ€ï¼Œå¹¶è®¡åˆ’æ‰§è¡Œå‰¯ä½œç”¨ Eã€‚</strong></p>
<h3 id="341">3.4.1 å‡½æ•°ç­¾å</h3>
<p>$$ (CurrentState, Event) \Rightarrow (NewState, EffectDescriptor[]) $$</p>
<p>æ³¨æ„è¿”å›å€¼åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li><strong>NewState</strong>: ç«‹å³ç”Ÿæ•ˆçš„å†…å­˜å˜æ›´ã€‚</li>
<li><strong>EffectDescriptor[]</strong>: <strong>æè¿°</strong>éœ€è¦åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯ç›´æ¥åšã€‚</li>
</ol>
<h3 id="342">3.4.2 æ¡ˆä¾‹ï¼šçŠ¶æ€æœºé€»è¾‘</h3>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå…·ä½“çš„ Reducer é€»è¾‘ç‰‡æ®µï¼ˆä¼ªä»£ç é€»è¾‘ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>Function MainReducer(state, event):

    // åœºæ™¯ï¼šç”¨æˆ·æ­£åœ¨è¯´è¯ï¼Œæ‰“æ–­äº†æœºå™¨äººçš„æ€è€ƒ
    if state.Stage == &quot;Thinking&quot; AND event.Type == &quot;VAD_USER_START_TALKING&quot;:
        return (
            state.copy(
                Stage = &quot;Listening&quot;,
                Buffer.append(event.payload)
            ),
            [ 
              Cmd.CancelCurrentLLM(),  // è¿™æ˜¯ä¸€ä¸ªæè¿°å¯¹è±¡ï¼Œä¸æ˜¯å‡½æ•°è°ƒç”¨
              Cmd.UI.ShowStatus(&quot;Listening...&quot;) 
            ]
        )

    // åœºæ™¯ï¼šå·¥å…·è°ƒç”¨æˆåŠŸè¿”å›
    if state.Stage == &quot;ToolUse&quot; AND event.Type == &quot;TOOL_SUCCESS&quot;:
        return (
            state.copy(
                Stage = &quot;Synthesizing&quot;,
                Conversation.History.add(ToolMessage(event.data))
            ),
            [ Cmd.RunLLM(prompt=build_prompt(state)) ]
        )

    return (state, []) // é»˜è®¤æ— å˜åŒ–
</code></pre></div>

<p><strong>å…³é”®åŸåˆ™</strong>ï¼šReducer å†…éƒ¨<strong>é›¶å‰¯ä½œç”¨</strong>ã€‚ç¦æ­¢ <code>print</code>ï¼Œç¦æ­¢ <code>requests.get</code>ï¼Œç¦æ­¢ <code>time.sleep</code>ã€‚å®ƒå¿…é¡»æ˜¯æ•°å­¦æ„ä¹‰ä¸Šçš„çº¯å‡½æ•°ï¼Œè¿™ä¿è¯äº†ç³»ç»Ÿçš„<strong>ç¡®å®šæ€§ï¼ˆDeterminismï¼‰</strong>ã€‚</p>
<hr />
<h2 id="35-effect">3.5 Effect æ‰§è¡Œå™¨ï¼šå‰¯ä½œç”¨çš„â€œéš”ç¦»ç—…æˆ¿â€</h2>
<p>Reducer åå‡ºçš„ <code>EffectDescriptor</code> åªæ˜¯æ•°æ®çš„â€œå¤„æ–¹â€ã€‚Runtime ä¸­çš„ <strong>Effect Orchestrator</strong> è´Ÿè´£æŒ‰å¤„æ–¹æŠ“è¯ã€‚</p>
<h3 id="351-effect">3.5.1 Effect æè¿°ç¬¦ç»“æ„</h3>
<div class="codehilite"><pre><span></span><code>EffectDescriptor
----------------
| id        | å…³è”çš„ Trigger Event ID (ç”¨äºæº¯æº)
| type      | HTTP / DB / LLM / TIMER / UI
| payload   | è¯·æ±‚å‚æ•° (URL, SQL, Prompt)
| policy    | æ‰§è¡Œç­–ç•¥ (RetryCount, Timeout, Priority)
| key       | å¹‚ç­‰é”® (ç”¨äºå»é‡)
</code></pre></div>

<h3 id="352">3.5.2 æ‰§è¡Œä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3>
<p>Effect Orchestrator ç›‘å¬ Reducer çš„è¾“å‡ºæµã€‚å½“æ”¶åˆ° Effect åˆ—è¡¨æ—¶ï¼š</p>
<ol>
<li>
<p><strong>Diff &amp; Schedule</strong>: æ¯”è¾ƒå½“å‰æ­£åœ¨è¿è¡Œçš„ Effect å’Œæ–°æ”¶åˆ°çš„ Effectã€‚</p>
<ul>
<li><em>New</em>: å¯åŠ¨æ–°çš„ Executorã€‚</li>
<li><em>Obsolete</em>: å¦‚æœæ–°åˆ—è¡¨ä¸­æ²¡æœ‰æ—§çš„ Effect IDï¼Œè¯´æ˜è¯¥ä»»åŠ¡è¢«å–æ¶ˆäº† -&gt; å‘é€ Abort ä¿¡å·ã€‚</li>
<li><em>Same</em>: ä¿æŒè¿è¡Œï¼Œä¸åšæ“ä½œã€‚</li>
</ul>
</li>
<li>
<p><strong>Execution Isolation</strong>: æ¯ä¸ª Effect åœ¨ç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ï¼ˆPromise/Future/Taskï¼‰ä¸­è¿è¡Œã€‚</p>
</li>
<li>
<p><strong>Feedback Loop</strong>:</p>
<ul>
<li>ä»»åŠ¡æˆåŠŸ -&gt; å‘å‡º <code>EffectResolvedEvent</code>ã€‚</li>
<li>ä»»åŠ¡å¤±è´¥ -&gt; å‘å‡º <code>EffectFailedEvent</code>ã€‚</li>
<li>è¿™äº› Event ä¼šå†æ¬¡è¿›å…¥ Event Busï¼Œè§¦å‘ä¸‹ä¸€æ¬¡ Reducer å¾ªç¯ã€‚</li>
</ul>
</li>
</ol>
<h3 id="353-switch-vs-merge">3.5.3 å¤æ‚çš„å¹¶å‘æ§åˆ¶ï¼šSwitch vs Merge</h3>
<p>Runtime éœ€è¦æ ¹æ® Effect ç±»å‹é€‰æ‹©ä¸åŒçš„ FRP ç­–ç•¥ï¼š</p>
<ul>
<li><strong>SwitchStrategy (æœ€æ–°ä¼˜å…ˆ)</strong>: é€‚ç”¨äº LLM æ¨ç†ã€‚å¦‚æœç”¨æˆ·æ”¹å£äº†ï¼Œæ—§çš„ LLM è¯·æ±‚åº”è¯¥ç«‹å³ä½œåºŸã€‚<ul>
<li><em>FRP ç®—å­</em>: <code>switchLatest</code></li>
</ul>
</li>
<li><strong>MergeStrategy (å¹¶å‘æ‰§è¡Œ)</strong>: é€‚ç”¨äºå¹¶è¡Œæœç´¢ã€‚åŒæ—¶æŸ¥ Google å’Œ Wikipediaï¼Œè°å…ˆå›æ¥æ— æ‰€è°“ï¼Œéƒ½è¦ã€‚<ul>
<li><em>FRP ç®—å­</em>: <code>merge</code></li>
</ul>
</li>
<li><strong>QueueStrategy (ä¸²è¡Œæ‰§è¡Œ)</strong>: é€‚ç”¨äºå†™æ•°æ®åº“æ—¥å¿—ã€‚å¿…é¡»æŒ‰é¡ºåºå†™ï¼Œä¸èƒ½å¹¶å‘ã€‚<ul>
<li><em>FRP ç®—å­</em>: <code>concat</code></li>
</ul>
</li>
</ul>
<hr />
<h2 id="36-checkpoint-snapshot">3.6 Checkpoint ä¸ Snapshotï¼šä»å´©æºƒä¸­é‡ç”Ÿ</h2>
<p>åœ¨å®æ—¶ Agent ä¸­ï¼ŒSession å¯èƒ½ä¼šæŒç»­å¾ˆä¹…ï¼ˆæ•°å°æ—¶ï¼‰ï¼ŒEvent Log ä¼šå˜å¾—å·¨å¤§ã€‚æˆ‘ä»¬ä¸èƒ½æ¯æ¬¡æ¢å¤éƒ½ä»ç¬¬ 1 ä¸ªäº‹ä»¶å¼€å§‹é‡æ”¾ã€‚</p>
<h3 id="361">3.6.1 æ··åˆæŒä¹…åŒ–ç­–ç•¥</h3>
<p>Runtime éœ€è¦ä¸€ä¸ªåå°è¿›ç¨‹ï¼Œæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p>
<ol>
<li><strong>WAL (Write-Ahead Log)</strong>: æ¯è¿›å…¥ Bus çš„ Event ç«‹å³è¿½åŠ å†™å…¥ç£ç›˜/DBã€‚è¿™æ˜¯â€œçœŸç†æ¥æºâ€ã€‚</li>
<li><strong>Periodic Snapshot</strong>:<ul>
<li>è§„åˆ™ï¼šæ¯å¤„ç† 100 ä¸ªäº‹ä»¶ æˆ– æ¯ 5 åˆ†é’Ÿã€‚</li>
<li>åŠ¨ä½œï¼šå°†å½“å‰ <code>AgentState</code> åºåˆ—åŒ–ä¸º JSON/Binaryï¼Œå­˜å…¥ Object Storeï¼Œæ ‡è®° Version Nã€‚</li>
<li>åŒæ—¶ï¼šæˆªæ–­ï¼ˆRotateï¼‰æ—§çš„ Logï¼Œåªä¿ç•™ Version N ä¹‹åçš„ Logã€‚</li>
</ul>
</li>
</ol>
<h3 id="362-hydration">3.6.2 æ¢å¤æµç¨‹ (Hydration)</h3>
<p>å½“æœåŠ¡é‡å¯æˆ–å‘ç”Ÿ Pod æ¼‚ç§»æ—¶ï¼š</p>
<ol>
<li>ä» DB è¯»å–æœ€æ–°çš„ Snapshot (Version N)ã€‚</li>
<li>ååºåˆ—åŒ–ä¸º <code>AgentState</code> å¯¹è±¡ã€‚</li>
<li>è¯»å– Version N ä¹‹åçš„æ‰€æœ‰ WAL Eventsã€‚</li>
<li>è¿è¡Œ <code>Reducer(State, Event)</code> å¾ªç¯ï¼ˆ<strong>æ³¨æ„ï¼šæ­¤æ—¶ç¦ç”¨ Effect æ‰§è¡Œå™¨</strong>ï¼‰ï¼Œå¿«é€Ÿâ€œå¿«è¿›â€åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚</li>
<li>æ¢å¤æ­£å¸¸æ¨¡å¼ï¼Œå¯ç”¨ Effect æ‰§è¡Œå™¨ã€‚</li>
</ol>
<hr />
<h2 id="37-agent-supervisor-tree">3.7 å¤š Agent ä¸å±‚çº§ (Supervisor Tree)</h2>
<p>å¤æ‚çš„ Agent ä¸æ˜¯å•ä½“ï¼Œè€Œæ˜¯<strong>åˆ†å½¢ï¼ˆFractalï¼‰</strong>çš„ã€‚</p>
<ul>
<li><strong>ä¸»æ§ (Main Agent)</strong>: è´Ÿè´£è·¯ç”±å’Œå…¨å±€ä¸Šä¸‹æ–‡ã€‚</li>
<li><strong>ä¸“å®¶ (Sub-Agent)</strong>: è´Ÿè´£ç‰¹å®šé¢†åŸŸï¼ˆå¦‚å†™ä»£ç ã€æœºç¥¨ï¼‰ã€‚</li>
</ul>
<h3 id="371-stream-of-streams">3.7.1 Stream of Streams</h3>
<p>åœ¨ Runtime ä¸­ï¼ŒSub-Agent æœ¬èº«å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ª <strong>Long-running Effect</strong>ã€‚</p>
<ol>
<li>Main Reducer å‘å‡º <code>Effect: SpawnSubAgent("Coder")</code>ã€‚</li>
<li>Runtime å¯åŠ¨ä¸€ä¸ªæ–°çš„ Stream å®ä¾‹ï¼ˆå­è¿è¡Œæ—¶ï¼‰ã€‚</li>
<li><strong>ç®¡é“è¿æ¥ (Piping)</strong>:<ul>
<li>Main Agent å°†éƒ¨åˆ† Event (å¦‚ç”¨æˆ·çš„ç‰¹å®šæŒ‡ä»¤) è½¬å‘ç»™ Sub-Agentã€‚</li>
<li>Sub-Agent çš„è¾“å‡º Event (å¦‚ä»£ç ç»“æœ) è¢«åŒ…è£…æˆ Main Agent çš„è¾“å…¥ Eventã€‚</li>
</ul>
</li>
</ol>
<p>è¿™ç§ç»“æ„ç±»ä¼¼äº Erlang çš„ Supervisor Treeï¼šå¦‚æœ Sub-Agent å´©æºƒï¼ŒMain Agent å¯ä»¥æ”¶åˆ° <code>ChildCrashEvent</code>ï¼Œå¹¶å†³å®šæ˜¯é‡å¯å®ƒè¿˜æ˜¯å‘ç”¨æˆ·é“æ­‰ã€‚</p>
<hr />
<h2 id="38-runtime">3.8 æ’ä»¶åŒ–æ¶æ„ï¼šRuntime æ‰©å±•ç‚¹</h2>
<p>ä¸ºäº†ä¿æŒ Runtime æ ¸å¿ƒä»£ç çš„é€šç”¨æ€§ï¼Œæ‰€æœ‰å…·ä½“ä¸šåŠ¡èƒ½åŠ›éƒ½åº”é€šè¿‡æ’ä»¶æ³¨å…¥ã€‚</p>
<p><strong>æ’ä»¶æ¥å£å®šä¹‰ (Protocol)</strong>:</p>
<ol>
<li>
<p><strong>ToolPlugin</strong>:</p>
<ul>
<li><code>manifest</code>: JSON Schemaï¼Œç”¨äºæ³¨å…¥ Promptã€‚</li>
<li><code>handler</code>: <code>(payload) =&gt; Promise&lt;Result&gt;</code>ï¼Œå®é™…æ‰§è¡Œé€»è¾‘ã€‚</li>
<li><code>cleanup</code>: èµ„æºå›æ”¶é’©å­ã€‚</li>
</ul>
</li>
<li>
<p><strong>MemoryPlugin</strong>:</p>
<ul>
<li><code>retrieve(state, query)</code>: å¦‚ä½•æ ¹æ®å½“å‰ State æŸ¥æ‰¾å‘é‡åº“ã€‚</li>
<li><code>observe(event)</code>: å“ªäº› Event å€¼å¾—è¢«å­˜å…¥é•¿æœŸè®°å¿†ã€‚</li>
</ul>
</li>
<li>
<p><strong>PolicyPlugin</strong> (é«˜çº§):</p>
<ul>
<li>å…è®¸æ›¿æ¢é»˜è®¤çš„ Reducer é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œåœ¨æ­¤æ’ä»¶ä¸­å®ç° ReAct å¾ªç¯æˆ– COTï¼ˆæ€ç»´é“¾ï¼‰é€»è¾‘ï¼Œè€Œä¸ä¿®æ”¹æ ¸å¿ƒ Runtimeã€‚</li>
</ul>
</li>
</ol>
<hr />
<h2 id="39">3.9 æœ¬ç« å°ç»“</h2>
<ol>
<li><strong>Runtime æ˜¯å¼•æ“</strong>ï¼šå®ƒè´Ÿè´£æ—¶é—´ã€å¹¶å‘ã€IO å’ŒçŠ¶æ€ç®¡ç†ï¼Œè®©ä¸šåŠ¡é€»è¾‘ä¿æŒçº¯ç²¹ã€‚</li>
<li><strong>Reducer æ¨¡å¼</strong>ï¼š$(State, Event) \rightarrow (NewState, Effect[])$ æ˜¯æ ¸å¿ƒå¾ªç¯ã€‚</li>
<li><strong>Effect æ˜¯æè¿°ç¬¦</strong>ï¼šæŠŠâ€œæƒ³åšæŸäº‹â€å’Œâ€œçœŸæ­£åšæŸäº‹â€åˆ†å¼€ï¼Œå®ç°äº†å¯æµ‹è¯•å’Œå¯å›æ”¾ã€‚</li>
<li><strong>çŠ¶æ€æ ‘</strong>ï¼šç»“æ„åŒ–çš„ã€ä¸å¯å˜çš„çŠ¶æ€æ ‘æ˜¯ç³»ç»Ÿçš„å•ä¸€äº‹å®æ¥æºï¼ˆSingle Source of Truthï¼‰ã€‚</li>
<li><strong>éŸ§æ€§</strong>ï¼šé€šè¿‡ WAL + Snapshot å®ç°å´©æºƒæ¢å¤ï¼›é€šè¿‡ Supervisor Tree å®ç°é”™è¯¯éš”ç¦»ã€‚</li>
</ol>
<hr />
<h2 id="310">3.10 ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  1ï¼šEffect vs Event è¾¨æ</strong>
åœ¨ Runtime æ—¥å¿—ä¸­çœ‹åˆ°äº†ä¸‹æ¡ç›®ï¼Œè¯·æ ‡è®°å®ƒæ˜¯ Event (E), State Change (S), è¿˜æ˜¯ Effect Descriptor (D):</p>
<ol>
<li><code>Payload: { "text": "Hello world" }, Source: User</code></li>
<li><code>Action: HTTP_POST, URL: api.weather.com</code></li>
<li><code>CurrentStage changed from "Idle" to "Fetching"</code></li>
<li><code>Payload: { "temp": 25 }, Source: WeatherAPI</code></li>
</ol>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<ol>
<li><strong>Event (E)</strong>: å¤–éƒ¨è¾“å…¥çš„äº‹å®ã€‚</li>
<li><strong>Effect Descriptor (D)</strong>: Reducer å‘å‡ºçš„æ„å›¾ï¼Œå°šæœªæ‰§è¡Œã€‚</li>
<li><strong>State Change (S)</strong>: Reducer è®¡ç®—åçš„ç»“æœã€‚</li>
<li><strong>Event (E)</strong>: å¤–éƒ¨ API è¿”å›çš„ç»“æœè¢«å°è£…æˆäº†äº‹ä»¶ã€‚</li>
</ol>
</details>
<p><strong>ç»ƒä¹  2ï¼šçº¯å‡½æ•°æ£€æŸ¥</strong>
ä»¥ä¸‹ Reducer ä»£ç æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿè¯·æŒ‡å‡ºè‡³å°‘ä¸¤å¤„è¿å Runtime è§„èŒƒçš„åœ°æ–¹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">bad_reducer</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ASK_TIME&quot;</span><span class="p">:</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># 1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User asked for time: </span><span class="si">{</span><span class="n">current_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># 2</span>
        <span class="n">db</span><span class="o">.</span><span class="n">log_access</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="c1"># 3</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">current_time</span><span class="p">)),</span> <span class="p">[]</span>
</code></pre></div>

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<ol>
<li><strong>éšå¼æ—¶é—´ä¾èµ–</strong>: <code>datetime.now()</code> ä½¿å‡½æ•°å˜å¾—ä¸ç¡®å®šã€‚åœ¨é‡æ”¾æ—¶ï¼Œæ—¶é—´ä¼šå˜æˆé‡æ”¾æ—¶çš„æ—¶é—´ï¼Œè€Œä¸æ˜¯äº‹ä»¶å‘ç”Ÿæ—¶çš„æ—¶é—´ã€‚åº”ä½¿ç”¨ <code>event.timestamp</code> æˆ–ä» <code>state.env.system_time</code> è·å–ã€‚</li>
<li><strong>IO å‰¯ä½œç”¨ (Print)</strong>: ä¸åº”åœ¨ reducer ä¸­æ‰“å°ï¼Œåº”é€šè¿‡æ—¥å¿—ä¸­é—´ä»¶è§‚å¯Ÿæµã€‚</li>
<li><strong>IO å‰¯ä½œç”¨ (DB)</strong>: <code>db.log_access</code> æ˜¯å†™æ•°æ®åº“æ“ä½œï¼Œå¿…é¡»å°è£…ä¸º <code>Effect</code> è¿”å›ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ã€‚</li>
</ol>
</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  3ï¼šè®¾è®¡â€œä¼˜é›…æ‰“æ–­â€æœºåˆ¶</strong>
åœºæ™¯ï¼šLLM æ­£åœ¨ç”Ÿæˆé•¿æ–‡æœ¬ï¼ˆStream Token Event æŒç»­æ¶Œå…¥ï¼‰ï¼Œæ­¤æ—¶ç”¨æˆ·è¯´äº†ä¸€å¥â€œç®—äº†ï¼Œæ¢ä¸ªè¯é¢˜â€ã€‚
è¯·æè¿° Runtime å†…éƒ¨å„ç»„ä»¶å¦‚ä½•ååŒå·¥ä½œï¼Œå®ç°ç«‹å³åœæ­¢ç”Ÿæˆå¹¶åˆ‡æ¢çŠ¶æ€ã€‚</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æç¤º)</summary>
<ol>
<li><strong>Input</strong>: Ingress æ”¶åˆ°éŸ³é¢‘ï¼ŒVAD è§¦å‘ <code>UserInterruptionEvent</code>ã€‚</li>
<li><strong>Reducer</strong>:<ul>
<li>æ”¶åˆ° Interruption Eventã€‚</li>
<li>è®¡ç®— NewState: å°† <code>Stage</code> ä» <code>Speaking</code> è®¾ä¸º <code>Listening</code>ï¼›ç©º <code>PendingOutputBuffer</code>ã€‚</li>
<li>ç”Ÿæˆ Effects: <code>[ Cmd.CancelTask(target="LLM_Generation"), Cmd.AudioPlayer.Stop() ]</code>ã€‚</li>
</ul>
</li>
<li><strong>Effect Orchestrator</strong>:<ul>
<li>æ”¶åˆ° <code>CancelTask</code> æŒ‡ä»¤ã€‚</li>
<li>æŸ¥æ‰¾æ­£åœ¨è¿è¡Œçš„ LLM è°ƒç”¨ä»»åŠ¡ï¼Œè°ƒç”¨å…¶ <code>AbortController.abort()</code>ã€‚</li>
<li>LLM è¿æ¥æ–­å¼€ï¼Œåœæ­¢äº§ç”Ÿæ–°çš„ Token Eventã€‚</li>
</ul>
</li>
<li><strong>State Consistency</strong>: å³ä½¿è¿˜æœ‰å‡ ä¸ªåœ¨ç½‘ç»œä¸Šâ€œé£â€çš„ Token Event éšååˆ°è¾¾ï¼Œç”±äº State å·²ç»å˜æ›´ä¸º <code>Listening</code>ï¼ŒReducer ä¼šæ ¹æ®å½“å‰çŠ¶æ€ä¸¢å¼ƒè¿™äº›è¿Ÿåˆ°çš„ Tokenã€‚</li>
</ol>
</details>
<p><strong>ç»ƒä¹  4ï¼šå®ç°â€œä¹è§‚æ›´æ–° (Optimistic UI)â€</strong>
ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œä¸ºäº†ä½“éªŒæµç•…ï¼Œæˆ‘ä»¬å¸Œæœ› UI ç«‹åˆ»æ˜¾ç¤ºæ¶ˆæ¯å·²ä¸Šå±ï¼Œè€Œä¸æ˜¯ç­‰æœåŠ¡å™¨ç¡®è®¤ã€‚ä½†åœ¨ FRP Runtime ä¸­ï¼ŒState å¿…é¡»ç”± Event é©±åŠ¨ã€‚å¦‚ä½•è®¾è®¡ Event åºåˆ—æ¥æ”¯æŒè¿™ç§ä½“éªŒï¼ŒåŒæ—¶åˆèƒ½å¤„ç†å‘é€å¤±è´¥çš„æƒ…å†µï¼Ÿ</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ (æç¤º)</summary>
<p>è®¾è®¡ä¸¤ä¸ª Eventï¼š</p>
<ol>
<li><strong><code>UserSubmitEvent</code> (Intent)</strong>: ç”¨æˆ·æŒ‰ä¸‹å›è½¦ã€‚<ul>
<li>Reducer å¤„ç†ï¼šå°†æ¶ˆæ¯åŠ å…¥ <code>state.conversation</code>ï¼Œä½†æ ‡è®°çŠ¶æ€ä¸º <code>pending</code>ï¼ˆç°è‰²ï¼‰ã€‚</li>
<li>Effectï¼šå‘èµ·ç½‘ç»œè¯·æ±‚å‘é€æ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li><strong><code>MessageAckEvent</code> (Fact)</strong>: æœåŠ¡å™¨ç¡®è®¤æ”¶åˆ°ã€‚<ul>
<li>Reducer å¤„ç†ï¼šæ‰¾åˆ°é‚£æ¡ <code>pending</code> æ¶ˆæ¯ï¼Œæ ‡è®°ä¸º <code>confirmed</code>ï¼ˆå®è‰²ï¼‰ï¼Œå¹¶æ›´æ–° <code>message_id</code>ã€‚</li>
</ul>
</li>
<li><strong><code>MessageFailEvent</code> (Fact)</strong>: å‘é€å¤±è´¥ã€‚<ul>
<li>Reducer å¤„ç†ï¼šå°†æ¶ˆæ¯æ ‡è®°ä¸º <code>error</code>ï¼Œæˆ–ä» State ä¸­ç§»é™¤å¹¶è§¦å‘ Toast æç¤ºã€‚</li>
</ul>
</li>
</ol>
</details>
<hr />
<h2 id="311-gotchas">3.11 å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<ol>
<li>
<p><strong>Trap: Effect çš„ç»“æœç›´æ¥ä¿®æ”¹ State</strong></p>
<ul>
<li><em>é”™è¯¯å†™æ³•</em>: Effect çš„å›è°ƒå‡½æ•°é‡Œå†™ <code>globalState.prop = value</code>ã€‚</li>
<li><em>åæœ</em>: ç»•è¿‡äº† Event Bus å’Œ Reducerï¼Œå¯¼è‡´çŠ¶æ€å˜æ›´ä¸å¯è¿½è¸ªï¼Œæ—¶é—´æ—…è¡Œå¤±æ•ˆï¼Œå¹¶å‘ç«æ€ã€‚</li>
<li><em>ä¿®æ­£</em>: Effect çš„å›è°ƒåªèƒ½ <code>emit(NewEvent)</code>ã€‚</li>
</ul>
</li>
<li>
<p><strong>Trap: å¿½ç•¥äº†â€œå»æŠ–åŠ¨ (Debounce)â€åœ¨ Runtime å±‚çš„å¿…è¦æ€§</strong></p>
<ul>
<li><em>ç°è±¡</em>: ç”¨æˆ·çš„éº¦å…‹é£æœ‰ç‚¹æ¥è§¦ä¸è‰¯ï¼Œ100ms å†…è§¦å‘äº† 5 æ¬¡ <code>DeviceConnect/Disconnect</code> äº‹ä»¶ã€‚</li>
<li><em>åæœ</em>: Reducer ç–¯ç‹‚çŠ¶æ€åˆ‡æ¢ï¼Œè§¦å‘äº† 5 æ¬¡é‡è¿ Effectï¼Œå¯¼è‡´æœåŠ¡å™¨è¢« DDoSã€‚</li>
<li><em>ä¿®æ­£</em>: åœ¨ Ingress å±‚æˆ– Reducer å‰ç½®ç®¡é“ä½¿ç”¨ <code>debounce</code> æˆ– <code>throttle</code> ç®—å­ï¼Œè¿‡æ»¤é«˜é¢‘å™ªå£°ã€‚</li>
</ul>
</li>
<li>
<p><strong>Trap: æ··æ·†é€»è¾‘æ—¶é—´ä¸ç‰©ç†æ—¶é—´</strong></p>
<ul>
<li><em>åœºæ™¯</em>: ä½ åœ¨åš Timeout æ£€æŸ¥ï¼Œä½¿ç”¨äº† <code>Date.now()</code>ã€‚</li>
<li><em>åæœ</em>: å½“ä½ ä»¥ 10 å€é€Ÿå›æ”¾æµ‹è¯•æ—¶ï¼ŒTimeout é€»è¾‘ä¼šå…¨éƒ¨é”™è¯¯ï¼Œå› ä¸ºç‰©ç†æ—¶é—´çš„æµé€é€Ÿåº¦å’Œå›æ”¾çš„é€»è¾‘æ—¶é—´æµé€é€Ÿåº¦ä¸åŒ¹é…ã€‚</li>
<li><em>ä¿®æ­£</em>: Runtime å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>VirtualClock</code>ï¼Œç”± <code>TickEvent</code> é©±åŠ¨ã€‚æ‰€æœ‰è®¡æ—¶é€»è¾‘éƒ½åŸºäºè¿™ä¸ªè™šæ‹Ÿæ—¶é’Ÿã€‚</li>
</ul>
</li>
<li>
<p><strong>Trap: æ­»å¾ªç¯äº‹ä»¶</strong></p>
<ul>
<li><em>åœºæ™¯</em>: Reducer æ”¶åˆ° Event A -&gt; å‘å‡º Effect B -&gt; Effect B æˆåŠŸåå‘å‡º Event Aã€‚</li>
<li><em>åæœ</em>: æ— é™é€’å½’ï¼Œæ ˆæº¢å‡ºæˆ–èµ„æºè€—å°½ã€‚</li>
<li><em>ä¿®æ­£</em>:<ul>
<li>åœ¨ Event Envelope ä¸­åŠ å…¥ <code>causality_chain</code>ï¼Œæ£€æµ‹åˆ°ç¯è·¯åˆ™ç†”æ–­ã€‚</li>
<li>Reducer é€»è¾‘å¿…é¡»æ”¶æ•›ï¼šä¿çŠ¶æ€å˜æ›´åï¼ŒåŒæ ·çš„ Event ä¸ä¼šå†æ¬¡è§¦å‘åŒæ ·çš„ Effectã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">â† Chapter 2ï½œFRP åŸºç¡€ï¼šç”¨äº‹ä»¶æµæè¿° Agent</a><a href="chapter4.html" class="nav-link next">Chapter 4ï½œPrompt Managementï¼šå†…åµŒç¯å¢ƒçŠ¶æ€æ’­æŠ¥ + æ—¶é—´å˜åŒ– â†’</a></nav>
        </main>
    </div>
</body>
</html>