<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 17ï½œå‚è€ƒå®ç°ï¼šä¸€ä¸ªç«¯åˆ°ç«¯çš„ FRP Agent</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ FRPï¼ˆFunctional Reactive Programmingï¼‰æ­å»º LLM å®æ—¶ Agentï¼šä»æŠ½è±¡åˆ°è½åœ°ã€‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1ï½œé—®é¢˜ç©ºé—´ä¸æ€»ä½“æ¶æ„ï¼šä¸ºä»€ä¹ˆç”¨ FRP</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2ï½œFRP åŸºç¡€ï¼šç”¨äº‹ä»¶æµæè¿° Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3ï½œæ ¸å¿ƒè¿è¡Œæ—¶ï¼šAgent ä½œä¸ºâ€œå¯ç»„åˆçš„ååº”ç³»ç»Ÿâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4ï½œPrompt Managementï¼šå†…åµŒç¯å¢ƒçŠ¶æ€æ’­æŠ¥ + æ—¶é—´å˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5ï½œç”¨æˆ·å¼‚æ­¥åŠ¨ä½œï¼šæ‰“æ–­ã€æ’¤å›ã€æ”¹å£ã€å¤šæ¨¡æ€è¾“å…¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6ï½œå·¥å…· / API è°ƒç”¨ï¼šå¤±æ•ˆå¤„ç†ã€å›é€€ã€å¹‚ç­‰ä¸éš”ç¦»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7ï½œRAG / DB / Python toolcallï¼šæŠŠçŸ¥è¯†ç®¡é“å˜æˆäº‹ä»¶æµ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8ï½œSpeculative Exec & Speculative Decodingï¼šè®©ç³»ç»Ÿâ€œæ›´å¿«ä¹Ÿæ›´ç¨³â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9ï½œDynamic Batching & å¹¶å‘ï¼šååã€å»¶è¿Ÿä¸å…¬å¹³æ€§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[Chapter 10ï½œäº‹ä»¶è§¦å‘å™¨ï¼šåšä¸€ä¸ªâ€œç±»ä¼¼ VADâ€çš„ Agent Trigger System](chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11ï½œRace Condition ä¸ä¸€è‡´æ€§ï¼šå¹¶å‘ä¸–ç•Œçš„â€œçœŸç›¸ç»´æŠ¤â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12ï½œToken Budget æ§åˆ¶ï¼šé¢„ç®—å°±æ˜¯äº§å“ä½“éªŒ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13ï½œæ—¥å¿—æŒä¹…åŒ–ä¸å¯è§‚æµ‹æ€§ï¼šTracing/Replay/Metric ä¸€ä½“åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14ï½œäººç±»ç›´è§‚ UIï¼ˆå«éŸ³æ•ˆï¼‰ä¸åå° Debug å¯è§†åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 15ï½œå®‰å…¨ã€éšç§ä¸æ²»ç†ï¼šè®© Agent å¯ä¸Šçº¿ã€å¯åˆè§„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 16ï½œè¯„æµ‹ä¸æŒç»­è¿­ä»£ï¼šä»â€œèƒ½ç”¨â€åˆ°â€œå¥½ç”¨â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 17ï½œå‚è€ƒå®ç°ï¼šä¸€ä¸ªç«¯åˆ°ç«¯çš„ FRP Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Aï½œæœ¯è¯­è¡¨ & FRP ç®—å­é€ŸæŸ¥ (The Agent Developer's Rosetta Stone)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Bï½œæ•°æ®ç»“æ„ä¸åè®®ï¼šEvent/State/Receipt/Trace Schema</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Cï½œæµ‹è¯•æ–¹æ³•ï¼šè™šæ—¶é—´ã€å›æ”¾ä¸æ··æ²Œå·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-17-frp-agent">Chapter 17ï½œå‚è€ƒå®ç°ï¼šä¸€ä¸ªç«¯åˆ°ç«¯çš„ FRP Agent</h1>
<h2 id="1">1. å¼€ç¯‡ä¸ç›®æ ‡</h2>
<p>è®¾è®¡ä¸€ä¸ªå®æ—¶ Agent ç³»ç»Ÿæœ€éš¾çš„ä¸æ˜¯è°ƒç”¨ <code>openai.chat.completions.create</code>ï¼Œè€Œæ˜¯å¤„ç†â€œæ··ä¹±â€ï¼šç”¨æˆ·åœ¨æ¨¡å‹è¾“å‡ºä¸€åŠæ—¶æ‰“æ–­ã€ç½‘ç»œæ³¢åŠ¨å¯¼è‡´å·¥å…·è¶…æ—¶ã€å¹¶å‘è¯·æ±‚å¼•å‘çš„ç«æ€æ¡ä»¶ã€ä»¥åŠ Token é¢„ç®—çš„åŠ¨æ€ç®¡ç†ã€‚</p>
<p>æœ¬ç« å°†é€šè¿‡ä¸€å¥—å®Œæ•´çš„<strong>å‚è€ƒæ¶æ„ï¼ˆReference Architectureï¼‰</strong>æ¥è§£å†³è¿™äº›æ··ä¹±ã€‚æˆ‘ä»¬ä½¿ç”¨ç±» Python çš„ä¼ªä»£ç ï¼ˆç»“åˆ Rx/ReactiveX è¯­ä¹‰ï¼‰æ¥æ„å»ºç³»ç»Ÿã€‚</p>
<p><strong>æœ¬ç« å­¦ä¹ ç›®æ ‡</strong>ï¼š</p>
<ol>
<li><strong>æ¶æ„è½åœ°</strong>ï¼šæŒæ¡â€œå…­è¾¹å½¢æ¶æ„â€åœ¨ FRP Agent ä¸­çš„å…·ä½“ç›®å½•ç»“æ„ä¸èŒè´£åˆ’åˆ†ã€‚</li>
<li><strong>æ ¸å¿ƒå¾ªç¯</strong>ï¼šå®ç°ä» <code>Input Event</code> åˆ° <code>State Update</code> å†åˆ° <code>Side Effect</code> çš„é—­ç¯ã€‚</li>
<li><strong>é«˜çº§æµæ§</strong>ï¼šç”¨ä»£ç å®ç° Speculative Decodingï¼ˆæŠ•æœºè§£ç ï¼‰ä¸ Dynamic Batchingï¼ˆåŠ¨æ€æ‰¹å¤„ç†ï¼‰ã€‚</li>
<li><strong>å…¨é“¾è·¯é›†æˆ</strong>ï¼šå°† RAGã€å·¥å…·è°ƒç”¨ã€é¢„ç®—æ§åˆ¶å’Œ UI æ¸²æŸ“æ•´åˆåˆ°ä¸€ä¸ªç»Ÿä¸€çš„æµä¸­ã€‚</li>
</ol>
<hr />
<h2 id="2">2. ç³»ç»Ÿå…¨æ™¯ä¸ç›®å½•ç»“æ„</h2>
<p>æˆ‘ä»¬çš„æ¶æ„éµå¾ª<strong>çº¯é€»è¾‘å†…æ ¸ï¼ˆFunctional Coreï¼‰</strong>ä¸<strong>å‘½ä»¤å¼å¤–å£³ï¼ˆImperative Shellï¼‰</strong>åˆ†ç¦»çš„åŸåˆ™ã€‚</p>
<h3 id="21-project-layout">2.1 ç›®å½•ç»“æ„ (Project Layout)</h3>
<div class="codehilite"><pre><span></span><code>/src
  /agent_core               &lt;-- [çº¯é€»è¾‘å±‚] æ— å‰¯ä½œç”¨ï¼Œçº¯å‡½æ•°ï¼Œå¯å®Œå…¨å›æ”¾æµ‹è¯•
    â”œâ”€â”€ events.py           # å®šä¹‰æ‰€æœ‰äº‹ä»¶ (UserAction, SystemSignal, ToolReceipt)
    â”œâ”€â”€ state.py            # å®šä¹‰ä¸å¯å˜çŠ¶æ€æ ‘ (AgentState, ConversationHistory)
    â”œâ”€â”€ reducers.py         # çŠ¶æ€è½¬ç§»å‡½æ•°: (State, Event) -&gt; State
    â”œâ”€â”€ selectors.py        # æ´¾ç”ŸçŠ¶æ€é€»è¾‘: State -&gt; Prompt, State -&gt; UI_ViewModel
    â””â”€â”€ triggers.py         # å¤æ‚çš„è§¦å‘å™¨é€»è¾‘ (VAD, Interrupt logic)

  /runtime                  &lt;-- [è¿è¡Œæ—¶å±‚] è´Ÿè´£æµçš„ç»„è£…ä¸è°ƒåº¦
    â”œâ”€â”€ pipeline.py         # ä¸»ç®¡é“ wiring (merge, scan, map)
    â”œâ”€â”€ scheduler.py        # æ‰¹å¤„ç†ä¸é€Ÿç‡é™åˆ¶ç­–ç•¥
    â””â”€â”€ loop.py             # ä¸»å¾ªç¯å…¥å£

  /effects                  &lt;-- [å‰¯ä½œç”¨å±‚] åªæœ‰è¿™é‡Œå¯ä»¥å‘èµ·ç½‘ç»œè¯·æ±‚/IO
    â”œâ”€â”€ llm_gateway.py      # LLM API åŒ…è£… (æ”¯æŒ Stream/Batch/Speculative)
    â”œâ”€â”€ tool_runner.py      # å·¥å…·æ‰§è¡Œå™¨ (Sandbox, Retry, CircuitBreaker)
    â”œâ”€â”€ rag_service.py      # å‘é‡æ•°æ®åº“æ£€ç´¢ä¸é‡æ’
    â””â”€â”€ memory_store.py     # æŒä¹…åŒ–å­˜å‚¨ (Postgres/Redis)

  /interfaces               &lt;-- [é€‚é…å™¨å±‚] è¾“å…¥è¾“å‡ºè½¬æ¢
    â”€â”€ websocket_server.py # WebSocket åè®®é€‚é…
    â”œâ”€â”€ audio_processor.py  # éŸ³é¢‘æµåˆ†å¸§ä¸ VAD é¢„å¤„ç†
    â””â”€â”€ debug_console.py    # å¼€å‘è€…åå°æ•°æ®æµ

  /tests                    &lt;-- [æµ‹è¯•å±‚]
    â”œâ”€â”€ test_reducers.py    # å•å…ƒæµ‹è¯•
    â””â”€â”€ sim_scenarios.py    # è™šæ‹Ÿæ—¶é—´å›æ”¾æµ‹è¯• (Time-Travel Testing)
</code></pre></div>

<h3 id="22-the-architecture-diagram">2.2 æ ¸å¿ƒæ•°æ®æµæ¶æ„ (The Architecture Diagram)</h3>
<p>è¿™ä¸ª ASCII å›¾å±•ç¤ºäº†æ•°æ®å¦‚ä½•åœ¨ä¸åŒå±‚çº§é—´æµåŠ¨ã€‚</p>
<div class="codehilite"><pre><span></span><code>       [  Real World  ]
            | (Inputs: Audio/Text/Click)
            v
    +-------+-------+
    |   Interfaces  |  -&gt; Normalize to Events
    +-------+-------+
            |  Stream&lt;Event&gt; (UserEvent, TimerEvent)
            v
    +-------+-------+      +----------------------+
    |  Runtime Hub  |&lt;-----|  Effect Feedback Loop|
    +-------+-------+      +----------+-----------+
            |                         ^
            | (Merge All Streams)     | Stream&lt;Event&gt; (ToolResult, Error)
            v                         |
    +-------+-------+                 |
    |   Agent Core  |                 |
    | (Scan/Reduce) |                 |
    +-------+-------+                 |
            | Stream&lt;State&gt;           |
            v                         |
    +-------+-------+      +----------+-----------+
    | State Selector|-----&gt;|    Effect Runners    |
    +-------+-------+      | (LLM, Tools, RAG)    |
            |              +----------------------+
            | Derived View (UI Frame, Audio Buffer)
            v
    +-------+-------+
    |   Interfaces  |  -&gt; Render to User
    +-------+-------+
</code></pre></div>

<hr />
<h2 id="3-event-bus-stream-loop">3. æ ¸å¿ƒè¿è¡Œæ—¶ï¼šEvent Bus ä¸ Stream Loop</h2>
<p>è¿™æ˜¯ç³»ç»Ÿçš„è„Šæ¢ã€‚æˆ‘ä»¬ä¸ä½¿ç”¨æ˜¾å¼çš„å›è°ƒå‡½æ•°ï¼Œè€Œæ˜¯å®šä¹‰â€œæµçš„æ‹“æ‰‘ç»“æ„â€ã€‚</p>
<h3 id="31">3.1 å®šä¹‰åŸºæœ¬ç±»å‹</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># åŸºç¡€äº‹ä»¶å®šä¹‰</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

<span class="c1"># ä¸å¯å˜çŠ¶æ€å®šä¹‰</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AgentState</span><span class="p">:</span>
    <span class="n">history</span><span class="p">:</span> <span class="nb">list</span>               <span class="c1"># å¯¹è¯å†å²</span>
    <span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>   <span class="c1"># æå–çš„æ§½ä½ (Slot Filling)</span>
    <span class="n">pending_actions</span><span class="p">:</span> <span class="nb">list</span>       <span class="c1"># å¾…æ‰§è¡Œçš„å‰¯ä½œç”¨æ„å›¾</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>                 <span class="c1"># &#39;IDLE&#39;, &#39;THINKING&#39;, &#39;ACTING&#39;, &#39;SPEAKING&#39;</span>
    <span class="n">last_active</span><span class="p">:</span> <span class="nb">float</span>          <span class="c1"># æœ€åæ´»è·ƒæ—¶é—´</span>
    <span class="n">token_usage</span><span class="p">:</span> <span class="nb">dict</span>           <span class="c1"># é¢„ç®—æ¶ˆè€—</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">)</span>
</code></pre></div>

<h3 id="32-the-pipeline-wiring">3.2 ä¸»ç®¡é“ç»„è£… (The Pipeline Wiring)</h3>
<p>è¿™æ®µä»£ç æ˜¯ Agent çš„â€œå¯åŠ¨è„šæœ¬â€ï¼Œå®ƒä¸æ‰§è¡Œé€»è¾‘ï¼Œåªè¿æ¥ç”µç¼†ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">build_agent_pipeline</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">InputStreams</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">ServiceContainer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ç»„è£… FRP ç®¡é“ã€‚</span>
<span class="sd">    inputs: åŒ…å« user_input$, interrupt$, system_tick$ ç­‰æºæµ</span>
<span class="sd">    services: åŒ…å« llm, tools, db ç­‰å‰¯ä½œç”¨æ‰§è¡Œå™¨</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1. åé¦ˆå›è·¯ (Feedback Loop) çš„å ä½ç¬¦</span>
    <span class="c1"># è¿™æ˜¯ä¸€ä¸ª Subjectï¼Œå…è®¸æˆ‘ä»¬åœ¨ç®¡é“ä¸‹æ¸¸æŠŠç»“æœå¡å›ä¸Šæ¸¸</span>
    <span class="n">action_result_stream</span> <span class="o">=</span> <span class="n">Subject</span><span class="p">()</span>

    <span class="c1"># 2. åˆå¹¶æ‰€æœ‰äº‹ä»¶æº</span>
    <span class="c1"># - ç”¨æˆ·è¾“å…¥</span>
    <span class="c1"># - å®šæ—¶å™¨å¿ƒè·³ (ç”¨äºè¶…æ—¶æ£€æŸ¥ã€ç¯å¢ƒæ’­æŠ¥)</span>
    <span class="c1"># - å·¥å…·/LLM çš„æ‰§è¡Œç»“æœ</span>
    <span class="n">all_events</span><span class="err">$</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">user_input</span><span class="err">$</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">UserEvent</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">interrupt</span><span class="err">$</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">InterruptEvent</span><span class="p">()),</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">system_tick</span><span class="err">$</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">TickEvent</span><span class="p">(</span><span class="n">t</span><span class="p">)),</span>
        <span class="n">action_result_stream</span>  <span class="c1"># å›ç¯å…¥å£</span>
    <span class="p">)</span>

    <span class="c1"># 3. æ ¸å¿ƒçŠ¶æ€æœº (The Brain)</span>
    <span class="c1"># æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘éƒ½åœ¨ reducer ä¸­</span>
    <span class="n">state</span><span class="err">$</span> <span class="o">=</span> <span class="nb">all</span>\<span class="n">_events</span><span class="err">$</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">reducer</span><span class="o">=</span><span class="n">core_reducer</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">AgentState</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">share</span><span class="p">()</span>  <span class="c1"># å¹¿æ’­ç»™å¤šä¸ªæ¶ˆè´¹è€…</span>

    <span class="c1"># 4. å‰¯ä½œç”¨æ„å›¾è¯†åˆ« (Intent Detection)</span>
    <span class="c1"># æ£€æŸ¥çŠ¶æ€æ˜¯å¦æš—ç¤ºéœ€è¦æ‰§è¡Œå¤–éƒ¨æ“ä½œ (è°ƒç”¨ LLM, æœç´¢ DB)</span>
    <span class="n">effect_intent</span><span class="err">$</span> <span class="o">=</span> <span class="n">state</span><span class="err">$</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">pending_actions</span><span class="p">)</span> \
                           <span class="o">.</span><span class="n">distinct_until_changed</span><span class="p">()</span> \
                           <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">actions</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 5. ä½œç”¨åˆ†å‘ä¸æ‰§è¡Œ (Side Effect Dispatcher)</span>
    <span class="c1"># å°† Intent è·¯ç”±ç»™ä¸åŒçš„æ‰§è¡Œå™¨ï¼Œå¹¶å°†ç»“æœå‘å› action_result_stream</span>
    <span class="n">effect_intent</span><span class="err">$</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">actions</span><span class="p">:</span> <span class="n">dispatch_effects</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span> <span class="n">action_result_stream</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 6. UI æ¸²æŸ“æµ</span>
    <span class="c1"># ä½¿ç”¨ throttle é¿å… UI åˆ·æ–°è¿‡å¿«ï¼ˆå¦‚ 60fpsï¼‰</span>
    <span class="n">ui_view</span><span class="err">$</span> <span class="o">=</span> <span class="n">state</span><span class="err">$</span><span class="o">.</span><span class="n">throttle_time</span><span class="p">(</span><span class="mf">0.016</span><span class="p">)</span> \
                     <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">render_ui_view_model</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ui_view</span><span class="err">$</span>
</code></pre></div>

<hr />
<h2 id="4-promptsignal-prompt">4. PromptSignalï¼šä»çŠ¶æ€åˆ°åŠ¨æ€ Prompt</h2>
<p>åœ¨ FRP æ¶æ„ä¸­ï¼ŒPrompt ä¸æ˜¯ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯<strong>çŠ¶æ€çš„å‡½æ•°</strong>ã€‚</p>
<h3 id="41-prompt">4.1 åŠ¨æ€ Prompt æ„é€ å™¨</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">derive_prompt</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Selector å‡½æ•°ï¼šçº¯å‡½æ•°ï¼Œ(State) -&gt; Messages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1. åŠ¨æ€ç³»ç»ŸæŒ‡ä»¤ (System Prompt)</span>
    <span class="c1"># åŒ…å«æ—¶é—´ã€ä½ç½®ã€å½“å‰æ¨¡å¼</span>
    <span class="n">system_content</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">base_prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">clock_now</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="n">location</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">),</span>
        <span class="n">tool_status</span><span class="o">=</span><span class="n">format_tool_status</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tool_registry</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 2. æ³¨å…¥çŸ­æœŸè®°å¿†ä¸ RAG ä¸Šä¸‹æ–‡</span>
    <span class="c1"># æ³¨æ„ï¼šRAG çš„ç»“æœæ˜¯åœ¨ä¹‹å‰çš„ reducer æ­¥éª¤ä¸­å­˜å…¥ state çš„</span>
    <span class="n">context_msgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">rag_evidence</span><span class="p">:</span>
        <span class="n">context_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Relevant Context:</span><span class="se">\n</span><span class="si">{</span><span class="n">format_evidence</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">rag_evidence</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">})</span>

    <span class="c1"># 3. å†å²è®°å½•å‹ç¼© (Context Budgeting)</span>
    <span class="c1"># åªæœ‰è¿™é‡Œåšæˆªæ–­ï¼Œä¿æŒ State é‡Œçš„ history æ˜¯å®Œæ•´çš„</span>
    <span class="n">visible_history</span> <span class="o">=</span> <span class="n">smart_trim</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">context_window</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_content</span><span class="p">}]</span> <span class="o">+</span> \
           <span class="n">context_msgs</span> <span class="o">+</span> \
           <span class="n">visible_history</span>
</code></pre></div>

<hr />
<h2 id="5-tool-effect">5. Tool Effect æ‰§è¡Œå™¨ä¸å›æ‰§</h2>
<p>å·¥å…·è°ƒç”¨æ˜¯å¼‚æ­¥çš„ã€æ˜“é”™çš„ã€‚æˆ‘ä»¬éœ€è¦ä¼˜é›…åœ°å¤„ç†å®ƒä»¬ã€‚</p>
<h3 id="51-reducer">5.1 Reducer ä¸­çš„æ„å›¾ç”Ÿæˆ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">core_reducer</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">AgentState</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentState</span><span class="p">:</span>
    <span class="c1"># ... çœç•¥å…¶ä»–äº‹ä»¶å¤„ç† ...</span>

    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;LLM_RESPONSE_CHUNK&quot;</span><span class="p">:</span>
        <span class="c1"># å¦‚æœ LLM è¾“å‡ºè¡¨æ˜è¦è°ƒç”¨å·¥å…·</span>
        <span class="k">if</span> <span class="n">is_tool_call_token</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">):</span>
            <span class="c1"># å°†â€œå¾…æ‰§è¡Œå·¥å…·â€åŠ å…¥ pending_actions</span>
            <span class="c1"># æ³¨æ„ï¼šè¿™é‡Œä¸æ‰§è¡Œå·¥å…·ï¼Œåªæè¿°â€œæˆ‘æƒ³æ‰§è¡Œå·¥å…·â€</span>
            <span class="n">new_action</span> <span class="o">=</span> <span class="n">ToolAction</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">params</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">pending_actions</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">pending_actions</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_action</span><span class="p">],</span>
                <span class="n">status</span><span class="o">=</span><span class="s1">&#39;ACTING&#39;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div>

<h3 id="52-the-runner">5.2 æ‰§è¡Œå™¨ (The Runner)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">dispatch_effects</span><span class="p">(</span><span class="n">actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">services</span><span class="p">,</span> <span class="n">result_sink</span><span class="p">:</span> <span class="n">Subject</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">ToolAction</span><span class="p">):</span>
            <span class="c1"># å¯åŠ¨å¼‚æ­¥ä»»åŠ¡</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="n">run_tool_safely</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">tools</span><span class="p">,</span> <span class="n">result_sink</span><span class="p">)</span>
            <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_tool_safely</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">tool_registry</span><span class="p">,</span> <span class="n">result_sink</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Chapter 6: Circuit Breaker &amp; Retry é€»è¾‘åœ¨è¿™é‡Œå°è£…</span>
        <span class="n">tool_func</span> <span class="o">=</span> <span class="n">tool_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="n">result_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tool_func</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;TOOL_RESULT&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;action_id&quot;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># å…³è” ID</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">,</span>
                <span class="s2">&quot;receipt&quot;</span><span class="p">:</span> <span class="n">generate_receipt</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">result_data</span><span class="p">)</span> <span class="c1"># ç”Ÿæˆå›æ‰§</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;TOOL_ERROR&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;action_id&quot;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="p">)</span>

    <span class="c1"># å°†ç»“æœæ¨å›ä¸»ç®¡é“</span>
    <span class="n">result_sink</span><span class="o">.</span><span class="n">on_next</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-speculative-decoding-batching">6. Speculative Decoding ä¸ Batching</h2>
<p>ä¸ºäº†æè‡´çš„æ€§èƒ½ï¼Œæˆ‘ä»¬åœ¨ <code>Effect</code> å±‚å¼•å…¥é«˜çº§æµæ§ã€‚</p>
<h3 id="61-speculative-execution-frp">6.1 Speculative Execution (æŠ•æœºæ‰§è¡Œ) çš„ FRP å®ç°</h3>
<p>å‡è®¾æˆ‘ä»¬è¦åœ¨ç”¨æˆ·è¯´è¯æ—¶é¢„åŠ è½½å¯èƒ½çš„å·¥å…·ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·æåˆ°â€œå¤©æ°”â€ï¼Œæˆ‘ä»¬ä¸ä»…é¢„åŠ è½½å¤©æ°”å·¥å…·ï¼Œç”šè‡³å¯ä»¥æŠ•æœºæ€§åœ°å‘èµ·æŸ¥è¯¢ï¼‰ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åœ¨ pipeline ç»„è£…å±‚</span>
<span class="k">def</span> <span class="nf">attach_speculative_layer</span><span class="p">(</span><span class="n">user_input_stream</span><span class="err">$</span><span class="p">,</span> <span class="n">services</span><span class="p">):</span>

    <span class="c1"># 1. å¿«é€Ÿæ„å›¾è¯†åˆ«æµ (ä½¿ç”¨å°æ¨¡å‹)</span>
    <span class="n">intent_stream</span><span class="err">$</span> <span class="o">=</span> <span class="n">user</span>\<span class="n">_input</span>\<span class="n">_stream</span><span class="err">$</span> \
        <span class="o">.</span><span class="n">buffer_time</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> \  <span class="c1"># æ¯ 0.5 ç§’é‡‡æ ·ä¸€æ¬¡</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">buf</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">switch_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">small_model</span><span class="o">.</span><span class="n">predict_intent</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

    <span class="c1"># 2. æŠ•æœºæ€§é¢„çƒ­ (Prefetch)</span>
    <span class="n">intent_stream</span><span class="err">$</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">intent</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;search&#39;</span><span class="p">:</span>
            <span class="n">services</span><span class="o">.</span><span class="n">search_engine</span><span class="o">.</span><span class="n">warmup</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;db_query&#39;</span><span class="p">:</span>
            <span class="n">services</span><span class="o">.</span><span class="n">db_connection</span><span class="o">.</span><span class="n">ensure_active</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="62-dynamic-batching-rag">6.2 Dynamic Batching (RAG å‘é‡åŒ–)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">EmbeddingService</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_subject</span> <span class="o">=</span> <span class="n">Subject</span><span class="p">()</span>

        <span class="c1"># å†…éƒ¨æ‰¹å¤„ç†é€»è¾‘</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_subject</span> \
            <span class="o">.</span><span class="n">buffer_with_time_or_count</span><span class="p">(</span><span class="n">time_span</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_batch_request</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">share</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># è¿”å›ä¸€ä¸ª Future/Promiseï¼Œç­‰å¾…æµçš„å“åº”</span>
        <span class="n">req_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_subject</span><span class="o">.</span><span class="n">on_next</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">req_id</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_stream</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">req_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute_batch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
        <span class="c1"># çœŸæ­£å‘èµ·ä¸€æ¬¡ API è°ƒç”¨</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="c1"># é‡æ–°æ‹†åˆ†ç»“æœ</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">vec</span><span class="p">}</span> 
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">vectors</span><span class="p">)]</span>
</code></pre></div>

<hr />
<h2 id="7-rag">7. RAG ç®¡é“ä¸æµå¼è¯æ®</h2>
<p>å®ç°â€œè¾¹ç”Ÿæˆï¼Œè¾¹å±•ç¤ºå¼•ç”¨â€çš„æ•ˆæœã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">rag_effect_runner</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">rag_service</span><span class="p">,</span> <span class="n">result_sink</span><span class="p">):</span>
    <span class="c1"># RAG ä¸ä»…ä»…è¿”å›æ–‡æœ¬ï¼Œè¿˜è¿”å› Stream&lt;Evidence&gt;</span>
    <span class="n">evidence_stream</span> <span class="o">=</span> <span class="n">rag_service</span><span class="o">.</span><span class="n">search_stream</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">evidence_stream</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span>
        <span class="n">on_next</span><span class="o">=</span><span class="k">lambda</span> <span class="n">doc</span><span class="p">:</span> <span class="n">result_sink</span><span class="o">.</span><span class="n">on_next</span><span class="p">(</span>
            <span class="n">Event</span><span class="p">(</span><span class="s2">&quot;RAG_DOC_FOUND&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">doc</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">on_completed</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">result_sink</span><span class="o">.</span><span class="n">on_next</span><span class="p">(</span>
            <span class="n">Event</span><span class="p">(</span><span class="s2">&quot;RAG_SEARCH_FINISHED&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># åœ¨ Reducer ä¸­</span>
<span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;RAG_DOC_FOUND&quot;</span><span class="p">:</span>
        <span class="c1"># å¢é‡æ›´æ–°è¯æ®åˆ—è¡¨ï¼ŒUI å¯ä»¥ç«‹å³æ¸²æŸ“è¿™ä¸ªæ–°æ–‡æ¡£</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
            <span class="n">evidence_list</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">evidence_list</span> <span class="o">+</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">payload</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<hr />
<h2 id="8-trigger-dsl-vad">8. Trigger DSL (ç±»ä¼¼ VAD çš„è§¦å‘å™¨)</h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">operators</span> <span class="kn">import</span> <span class="n">debounce</span><span class="p">,</span> <span class="n">throttle</span>

<span class="k">def</span> <span class="nf">create_advanced_trigger</span><span class="p">(</span><span class="n">audio_energy</span><span class="err">$</span><span class="p">,</span> <span class="n">text</span>\<span class="n">_stream</span><span class="err">$</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    å®šä¹‰ä»€ä¹ˆæ—¶å€™ Agent åº”è¯¥æ‰“æ–­ç”¨æˆ·æˆ–å¼€å§‹è¯´è¯ã€‚</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># 1. ç‰©ç†å±‚ VADï¼šå£°éŸ³èƒ½é‡ &gt; é˜ˆå€¼ï¼ŒæŒç»­ 200ms</span>
    <span class="n">is_speaking</span><span class="err">$</span> <span class="o">=</span> <span class="n">audio</span>\<span class="n">_energy</span><span class="err">$</span> \
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">distinct_until_changed</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">debounce</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span> 

    <span class="c1"># 2. è¯­ä¹‰å±‚ VADï¼šæ£€æµ‹åˆ°å®Œæ•´å¥å­ç»“æŸç¬¦ (Semantic Endpointing)</span>
    <span class="n">is_sentence_end</span><span class="err">$</span> <span class="o">=</span> <span class="n">text</span>\<span class="n">_stream</span><span class="err">$</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">)))</span>

    <span class="c1"># 3. ç»„åˆé€»è¾‘</span>
    <span class="c1"># å¦‚æœæ£€æµ‹åˆ°â€œè¯´è¯ç»“æŸâ€ ä¸” â€œå¥å­å®Œæ•´â€ï¼Œè§¦å‘ TURN_END</span>
    <span class="n">turn_end</span><span class="err">$</span> <span class="o">=</span> <span class="ow">is</span>\<span class="n">_speaking</span><span class="err">$</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">speaking</span><span class="p">:</span> <span class="n">speaking</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">with_latest_from</span><span class="p">(</span><span class="n">is_sentence_end</span><span class="err">$</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">Event</span><span class="p">(</span><span class="s2">&quot;USER_TURN_END&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">turn_end</span><span class="err">$</span>
</code></pre></div>

<hr />
<h2 id="9">9. æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« é€šè¿‡ä¼ªä»£ç æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ FRP Agent éª¨æ¶ï¼š</p>
<ol>
<li><strong>Event Bus</strong> æ˜¯è¡€ç®¡ï¼Œè¿æ¥æ‰€æœ‰ç»„ä»¶ã€‚</li>
<li><strong>Reducer</strong> æ˜¯å¿ƒè„ï¼Œçº¯å‡€ä¸”è´Ÿè´£çŠ¶æ€ç»´æŠ¤ã€‚</li>
<li><strong>Selector</strong> æ˜¯å¤§è„‘çš®å±‚ï¼Œå°†çŠ¶æ€è½¬åŒ–ä¸º Prompt å’Œ UIã€‚</li>
<li><strong>Effect Runners</strong> æ˜¯å››è‚¢ï¼Œè´Ÿè´£å¤„ç†è‚®è„çš„ç°å®ä¸–ç•Œï¼ˆIO/APIï¼‰ã€‚</li>
</ol>
<p>è¿™ä¸ªæ¶æ„çš„å¨åŠ›åœ¨äºï¼š</p>
<ul>
<li><strong>å¯æµ‹è¯•æ€§</strong>ï¼šä½ å¯ä»¥ç¼–å†™ä¸€ä¸ª JSON æ–‡ä»¶åŒ…å«ä¸€ç³»åˆ— Eventï¼Œå–‚ç»™ Reducerï¼ŒéªŒè¯æœ€ç»ˆçŠ¶æ€æ˜¯å¦æ­£ç¡®å®Œå…¨ä¸éœ€è¦ Mock ç½‘ç»œè¯·æ±‚ã€‚</li>
<li><strong>å¯æ‰©å±•æ€§</strong>ï¼šæƒ³åŠ ä¸€ä¸ªâ€œæƒ…ç»ªæ£€æµ‹â€æ¨¡å—ï¼Ÿåªéœ€è®¢é˜… <code>audio_stream$</code>ï¼Œäº§ç”Ÿ <code>EMOTION_DETECTED</code> äº‹ä»¶ï¼Œå¹¶åœ¨ Reducer ä¸­å¤„ç†å³å¯ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰çš„ LLM é€»è¾‘ã€‚</li>
<li><strong>é²æ£’æ€§</strong>ï¼šé€šè¿‡ <code>timeout</code>, <code>retry</code>, <code>circuit_breaker</code> ç­‰ç®—å­ï¼Œç³»ç»Ÿå¤©ç”Ÿå…·å¤‡å®¹é”™èƒ½åŠ›ã€‚</li>
</ul>
<hr />
<h2 id="10">10. ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>Schema è®¾è®¡</strong>ï¼š
    è®¾è®¡ <code>ToolReceipt</code> çš„æ•°æ®ç»“æ„ã€‚è¦æ±‚åŒ…å«ï¼šè°ƒç”¨å·¥å…·çš„åŸå§‹å‚æ•°ã€å·¥å…·è¿”å›çš„ç»“æœã€ä»¥åŠä¸€ä¸ª summary å­—æ®µï¼ˆç”¨äºç»™ LLM çœ‹çš„ç®€åŒ–ç‰ˆç»“æœï¼ŒèŠ‚çœ Tokenï¼‰ã€‚
    <details markdown="1">
    <summary>å‚è€ƒç­”æ¡ˆ</summary></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ToolReceipt</span><span class="p">:</span>
    <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">call_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>

    <span class="c1"># åŸå§‹è¾“å…¥è¾“å‡ºï¼ˆç”¨äºæ—¥å¿—å’Œ Debugï¼‰</span>
    <span class="n">raw_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">raw_output</span><span class="p">:</span> <span class="n">Any</span>

    <span class="c1"># å‹ç¼©è§†å›¾ï¼ˆç”¨äº Promptï¼‰</span>
    <span class="n">summary_for_llm</span><span class="p">:</span> <span class="nb">str</span> 

    <span class="c1"># çŠ¶æ€å…ƒæ•°æ®</span>
    <span class="n">is_success</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">execution_time_ms</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;/details&gt;
</code></pre></div>

<ol start="2">
<li><strong>å¿ƒè·³å®ç°</strong>ï¼š
    ä½¿ç”¨ä½ ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆæˆ–ä¼ªä»£ç ï¼‰ï¼Œå†™ä¸€ä¸ª <code>tick_stream</code>ï¼Œæ¯ç§’å‘å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œä½†å¦‚æœ <code>state.status == 'SLEEPING'</code>ï¼Œåˆ™åœæ­¢å‘å°„äº‹ä»¶ä»¥èŠ‚çœèµ„æºã€‚
    <details markdown="1">
    <summary>å‚è€ƒç­”æ¡ˆ</summary></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># éœ€è¦ switch_map é…åˆçŠ¶æ€æµ</span>
<span class="n">tick_stream</span><span class="err">$</span> <span class="o">=</span> <span class="n">state</span>\<span class="n">_stream</span><span class="err">$</span> \
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">distinct_until_changed</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">switch_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">status</span><span class="p">:</span> 
        <span class="n">interval</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;SLEEPING&#39;</span> <span class="k">else</span> <span class="n">empty</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;/details&gt;
</code></pre></div>

<ol start="3">
<li><strong>æ—¥å¿—è„±æ•</strong>ï¼š
    å®ç°ä¸€ä¸ªç®€å•çš„ Operator <code>mask_pii</code>ï¼Œå®ƒæ¥æ”¶ Event æµï¼Œå°† payload ä¸­çš„ <code>phone_number</code> å’Œ <code>email</code> å­—æ®µæ›¿æ¢ä¸º <code>***</code>ã€‚
    <details markdown="1">
    <summary>æç¤º</summary>
    è¿™æ˜¯ä¸€ä¸ª <code>map</code> æ“ä½œã€‚å°½é‡åšæ·±æ‹·è´ï¼ˆdeep copyï¼‰ä»¥é¿å…ä¿®æ”¹åŸå§‹äº‹ä»¶å½±å“å…¶ä»–æ¶ˆè´¹è€…ã€‚å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¸¸è§çš„ PII æ¨¡å¼ã€‚
    </details></li>
</ol>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li>
<p><strong>å®ç°â€œä¹è§‚ UI æ›´æ–° (Optimistic UI Update)â€</strong>ï¼š
    å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼ŒUI ç«‹å³æ˜¾ç¤ºâ€œå‘é€æˆåŠŸâ€ï¼ˆç°è‰²çŠ¶æ€ï¼‰ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤ã€‚è¯·æè¿°åœ¨ FRP Reducer ä¸­å¦‚ä½•å¤„ç† <code>USER_SEND</code>ï¼ˆä¹è§‚ï¼‰å’Œ <code>SERVER_ACK</code>ï¼ˆç¡®è®¤ï¼‰è¿™ä¸¤ä¸ªäº‹ä»¶ï¼Œä»¥åŠå¦‚æœæ”¶åˆ° <code>SERVER_ERROR</code> å¦‚ä½•å›æ»šã€‚
    <details markdown="1">
    <summary>æç¤º</summary></p>
<ol>
<li><code>USER_SEND</code>: append message to history with <code>status='pending'</code>.</li>
<li><code>SERVER_ACK</code>: find message by ID, update <code>status='sent'</code>.</li>
<li><code>SERVER_ERROR</code>: find message by ID, update <code>status='failed'</code> or remove it from history (rollback).
å…³é”®åœ¨äºæ¯æ¡æ¶ˆæ¯éœ€è¦ä¸€ä¸ªä¸´æ—¶çš„å®¢æˆ·ç«¯ç”Ÿæˆçš„ UUIDã€‚
</details></li>
</ol>
</li>
<li>
<p><strong>è®¾è®¡ Token é¢„ç®—ç†”æ–­å™¨</strong>ï¼š
    åœ¨ <code>dispatch_effects</code> ä¹‹å‰æ‹¦æˆª LLM è¯·æ±‚ã€‚å¦‚æœ <code>current_session_tokens &gt; MAX_BUDGET</code>ï¼Œåˆ™æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶è‡ªåŠ¨æ´¾å‘ä¸€ä¸ª <code>Event("SYSTEM_MSG", "Budget Exceeded")</code> ç»™ Reducerï¼Œè€Œä¸æ˜¯è°ƒç”¨ LLM APIã€‚
    <details markdown="1">
    <summary>æç¤º</summary>
    ä½¿ç”¨ <code>compose</code> æˆ– <code>pipe</code> åœ¨æµä¸­æ’å…¥é€»è¾‘ã€‚</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="n">llm_intent</span><span class="err">$</span>
    <span class="o">.</span><span class="n">with_latest_from</span><span class="p">(</span><span class="n">budget_status</span><span class="err">$</span><span class="p">)</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">budget</span><span class="p">):</span> 
         <span class="k">if</span> <span class="n">budget</span><span class="o">.</span><span class="n">remaining</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">SystemEvent</span><span class="p">(</span><span class="s2">&quot;BUDGET_EXCEEDED&quot;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">intent</span>
    <span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>&lt;/details&gt;
</code></pre></div>

<hr />
<h2 id="11-gotchas">11. å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="111-infinite-loops">11.1 æ— é™é€’å½’ (Infinite Loops)</h3>
<p><strong>åœºæ™¯</strong>ï¼šReducer æ›´æ–°çŠ¶æ€ -&gt; çŠ¶æ€è§¦å‘ Effect -&gt; Effect äº§ç”Ÿ Event -&gt; Event è§¦å‘ Reducerã€‚
<strong>é™·é˜±</strong>ï¼šå¦‚æœä¸å°å¿ƒï¼Œè¿™ä¼šå˜æˆæ°¸åŠ¨æœºã€‚ä¾‹å¦‚ï¼šEffect å¤±è´¥å‘å‡º ERROR äº‹ä»¶ï¼ŒReducer æ”¶åˆ° ERROR å†³å®šé‡è¯•ï¼Œå†æ¬¡è§¦å‘ Effectã€‚
<strong>å¯¹ç­–</strong>ï¼š</p>
<ol>
<li><strong>é‡è¯•è®¡æ•°å™¨</strong>ï¼šåœ¨ Event payload æˆ– State ä¸­å¿…é¡»åŒ…å« <code>retry_count</code>ã€‚</li>
<li><strong>Base Condition</strong>ï¼šReducer å¿…é¡»æœ‰é€»è¾‘ <code>if retry_count &gt; 3: return state (give up)</code>ã€‚</li>
</ol>
<h3 id="112-ghost-subscriptions">11.2 å¹½çµè®¢é˜… (Ghost Subscriptions)</h3>
<p><strong>åœºæ™¯</strong>ï¼šåœ¨ Web ç¯å¢ƒä¸­ï¼Œç»„ä»¶å¸è½½äº†ï¼ˆå¦‚ç”¨æˆ·å…³é—­äº†æ ‡ç­¾é¡µæˆ–åˆ‡æ¢äº†ç”±ï¼‰ï¼Œä½†åå°çš„ Stream è®¢é˜…è¿˜åœ¨è¿è¡Œï¼Œç»§ç»­æ¶ˆè€— CPU å¤„ç† VAD æˆ–ç½‘ç»œè¯·æ±‚ã€‚
<strong>å¯¹ç­–</strong>ï¼š</p>
<ol>
<li>ç¡®ä¿æ‰€æœ‰çš„ <code>subscribe()</code> è¿”å›çš„ <code>Subscription</code> å¯¹è±¡è¢«æ”¶é›†ã€‚</li>
<li>åœ¨é”€æ¯ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ <code>dispose()</code> æˆ– <code>__exit__</code>ï¼‰ä¸­è°ƒç”¨ <code>subscription.unsubscribe()</code>ã€‚</li>
<li>ä½¿ç”¨ <code>take_until(destroy_signal$)</code> æ¨¡å¼è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ol>
<h3 id="113">11.3 çŠ¶æ€çš„å¯å˜æ€§æ±¡æŸ“</h3>
<p><strong>åœºæ™¯</strong>ï¼šåœ¨ Reducer ä¸­ç›´æ¥ä¿®æ”¹äº† <code>state.history.append(...)</code> è€Œä¸æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„ State å¯¹è±¡ã€‚
<strong>åæœ</strong>ï¼šç”±äº FRP ç»å¸¸ä½¿ç”¨ <code>distinct_until_changed</code> æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œå¦‚æœå¯¹è±¡å¼•ç”¨æ²¡å˜ï¼ˆåªæ˜¯å†…éƒ¨å†…å®¹å˜äº†ï¼‰ï¼Œä¸‹æ¸¸å¯èƒ½ä¸ä¼šæ£€æµ‹åˆ°å˜åŒ–ï¼Œå¯¼è‡´ UI ä¸åˆ·æ–°ã€‚
<strong>å¯¹ç­–</strong>ï¼šå§‹ç»ˆä½¿ç”¨ <code>dataclasses.replace</code> æˆ–ç±»ä¼¼åº“ï¼ˆå¦‚ immer.js / pyrsistentï¼‰æ¥ä¿è¯ä¸å¯å˜æ€§ã€‚</p>
            </article>
            
            <nav class="page-nav"><a href="chapter16.html" class="nav-link prev">â† Chapter 16ï½œè¯„æµ‹ä¸æŒç»­è¿­ä»£ï¼šä»â€œèƒ½ç”¨â€åˆ°â€œå¥½ç”¨â€</a><a href="chapter18.html" class="nav-link next">Appendix Aï½œæœ¯è¯­è¡¨ & FRP ç®—å­é€ŸæŸ¥ (The Agent Developer's Rosetta Stone) â†’</a></nav>
        </main>
    </div>
</body>
</html>