<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Appendix Bï½œæ•°æ®ç»“æ„ä¸åè®®ï¼šEvent/State/Receipt/Trace Schema</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ã€Šç”¨ FRPï¼ˆFunctional Reactive Programmingï¼‰æ­å»º LLM å®æ—¶ Agentï¼šä»æŠ½è±¡åˆ°è½åœ°ã€‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 1ï½œé—®é¢˜ç©ºé—´ä¸æ€»ä½“æ¶æ„ï¼šä¸ºä»€ä¹ˆç”¨ FRP</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 2ï½œFRP åŸºç¡€ï¼šç”¨äº‹ä»¶æµæè¿° Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 3ï½œæ ¸å¿ƒè¿è¡Œæ—¶ï¼šAgent ä½œä¸ºâ€œå¯ç»„åˆçš„ååº”ç³»ç»Ÿâ€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 4ï½œPrompt Managementï¼šå†…åµŒç¯å¢ƒçŠ¶æ€æ’­æŠ¥ + æ—¶é—´å˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 5ï½œç”¨æˆ·å¼‚æ­¥åŠ¨ä½œï¼šæ‰“æ–­ã€æ’¤å›ã€æ”¹å£ã€å¤šæ¨¡æ€è¾“å…¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 6ï½œå·¥å…· / API è°ƒç”¨ï¼šå¤±æ•ˆå¤„ç†ã€å›é€€ã€å¹‚ç­‰ä¸éš”ç¦»</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 7ï½œRAG / DB / Python toolcallï¼šæŠŠçŸ¥è¯†ç®¡é“å˜æˆäº‹ä»¶æµ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 8ï½œSpeculative Exec & Speculative Decodingï¼šè®©ç³»ç»Ÿâ€œæ›´å¿«ä¹Ÿæ›´ç¨³â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 9ï½œDynamic Batching & å¹¶å‘ï¼šååã€å»¶è¿Ÿä¸å…¬å¹³æ€§</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">[Chapter 10ï½œäº‹ä»¶è§¦å‘å™¨ï¼šåšä¸€ä¸ªâ€œç±»ä¼¼ VADâ€çš„ Agent Trigger System](chapter10.md)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 11ï½œRace Condition ä¸ä¸€è‡´æ€§ï¼šå¹¶å‘ä¸–ç•Œçš„â€œçœŸç›¸ç»´æŠ¤â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 12ï½œToken Budget æ§åˆ¶ï¼šé¢„ç®—å°±æ˜¯äº§å“ä½“éªŒ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 13ï½œæ—¥å¿—æŒä¹…åŒ–ä¸å¯è§‚æµ‹æ€§ï¼šTracing/Replay/Metric ä¸€ä½“åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 14ï½œäººç±»ç›´è§‚ UIï¼ˆå«éŸ³æ•ˆï¼‰ä¸åå° Debug å¯è§†åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 15ï½œå®‰å…¨ã€éšç§ä¸æ²»ç†ï¼šè®© Agent å¯ä¸Šçº¿ã€å¯åˆè§„</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 16ï½œè¯„æµ‹ä¸æŒç»­è¿­ä»£ï¼šä»â€œèƒ½ç”¨â€åˆ°â€œå¥½ç”¨â€</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Chapter 17ï½œå‚è€ƒå®ç°ï¼šä¸€ä¸ªç«¯åˆ°ç«¯çš„ FRP Agent</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Aï½œæœ¯è¯­è¡¨ & FRP ç®—å­é€ŸæŸ¥ (The Agent Developer's Rosetta Stone)</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Bï½œæ•°æ®ç»“æ„ä¸åè®®ï¼šEvent/State/Receipt/Trace Schema</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Cï½œæµ‹è¯•æ–¹æ³•ï¼šè™šæ—¶é—´ã€å›æ”¾ä¸æ··æ²Œå·¥ç¨‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Appendix Dï½œéƒ¨ç½²ä¸è¿ç»´ï¼šé…ç½®ã€ç°åº¦ã€å‘Šè­¦ä¸å®¹ç¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="appendix-beventstatereceipttrace-schema">Appendix Bï½œæ•°æ®ç»“æ„ä¸åè®®ï¼šEvent/State/Receipt/Trace Schema</h1>
<h2 id="1">1. å¼€ç¯‡æ®µè½ï¼šåè®®å³ç³»ç»Ÿ</h2>
<p>åœ¨ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰ä¸­ï¼Œç³»ç»Ÿçš„éª¨æ¶æ˜¯ç±»ï¼ˆClassesï¼‰å’Œæ¥å£ï¼ˆInterfacesï¼‰ï¼›è€Œåœ¨å‡½æ•°å¼å“åº”å¼ç¼–ç¨‹ï¼ˆFRPï¼‰ä¸­ï¼Œ<strong>ç³»ç»Ÿçš„éª¨æ¶æ˜¯æ•°æ®æµï¼ˆData Streamsï¼‰ä¸­çš„ Schema</strong>ã€‚</p>
<p>ç”±äº FRP å°†â€œè¡Œä¸ºâ€æŠ½è±¡ä¸ºç®—å­ï¼ˆOperatorsï¼‰ï¼Œç³»ç»Ÿä¸­æµåŠ¨çš„æ•°æ®ç»“æ„ï¼ˆPayloadsï¼‰å°±æˆä¸ºäº†å®šä¹‰ç³»ç»Ÿèƒ½åŠ›çš„å”¯ä¸€çº¦æŸã€‚ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ Schema ä½“ç³»èƒ½å¤Ÿå¸¦æ¥ä»¥ä¸‹å·¨å¤§çš„å·¥ç¨‹çº¢åˆ©ï¼š</p>
<ol>
<li><strong>Time Travel Debugging</strong>ï¼šåªè¦æ•°æ®ç»“æ„æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆSerializableï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½å½•åˆ¶å¹¶å›æ”¾ä»»ä½• Bugã€‚</li>
<li><strong>å‰åç«¯è§£è€¦</strong>ï¼šSchema å®šä¹‰äº† UI æ¸²æŸ“å±‚ä¸ Agent é€»è¾‘å±‚çš„å¥‘çº¦ã€‚</li>
<li><strong>å¼‚æ„ç³»ç»Ÿé›†æˆ</strong>ï¼šæ ‡å‡†çš„ä¿¡å°æ ¼å¼ä½¿å¾— Agent å¯ä»¥è½»æ¾æŒ‚è½½åˆ° WebSocketã€gRPC æˆ– HTTP Server ä¸Šã€‚</li>
</ol>
<p>æœ¬ç« ä¸è®¨è®ºå…·ä½“çš„æ•°æ®åº“é€‰å‹ï¼ˆSQL vs NoSQLï¼‰ï¼Œè€Œæ˜¯ä¸“æ³¨äºå®šä¹‰<strong>å†…å­˜ä¸­æµåŠ¨çš„æ•°æ®åè®®</strong>ã€‚æˆ‘ä»¬å°†è¯¦ç»†æ‹†è§£å››ä¸ªæ ¸å¿ƒç»´åº¦ï¼š<code>Event</code>ï¼ˆè¾“å…¥äº‹å®ï¼‰ã€<code>State</code>ï¼ˆèšåˆçŠ¶æ€ï¼‰ã€<code>Receipt</code>ï¼ˆå‰¯ä½œç”¨ç»“æœï¼‰å’Œ <code>Trace</code>ï¼ˆè§‚æµ‹å…ƒæ•°æ®ï¼‰ã€‚</p>
<hr />
<h2 id="2-schema">2. æ–‡å­—è®ºè¿°ä¸è¯¦ç»† Schema å®šä¹‰</h2>
<h3 id="b1-event-schema">B.1 Event Schemaï¼šä¸å¯å˜çš„åŸå­äº‹å®</h3>
<p>Event æ˜¯ç³»ç»Ÿä¸­å‘ç”Ÿçš„â€œäº‹æƒ…â€ã€‚åœ¨ FRP è¯­ä¹‰ä¸‹ï¼ŒEvent å¿…é¡»æ˜¯ <strong>Immutableï¼ˆä¸å¯å˜ï¼‰</strong> çš„ã€‚ä¸€æ—¦äº§ç”Ÿï¼Œå®ƒå°±æ˜¯å†å²çš„ä¸€éƒ¨åˆ†ï¼Œä¸å¯ä¿®æ”¹ã€‚</p>
<h4 id="211-the-universal-envelope">2.1.1 é€šç”¨ä¿¡å° (The Universal Envelope)</h4>
<p>ä¸ºäº†è®© Runtime èƒ½å¤Ÿç»Ÿä¸€å¤„ç†æ—¥å¿—ã€è·¯ç”±ã€é‡è¯•å’Œåºåˆ—åŒ–ï¼Œæ‰€æœ‰å…·ä½“çš„ä¸šåŠ¡äº‹ä»¶éƒ½å¿…é¡»åŒ…è£¹åœ¨ä¸€ä¸ªæ ‡å‡†ä¿¡å°ä¸­ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>

<span class="cm"> * æ ‡å‡†äº‹ä»¶ä¿¡å° (The Envelope)</span>
<span class="cm"> * T: å…·ä½“çš„ Payload ç±»å‹</span>
<span class="cm"> */</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">AgentEvent</span><span class="o">&lt;</span><span class="nx">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// --- æ ‡è¯†åŒº ---</span>

<span class="w">  </span><span class="c1">// å”¯ä¸€ IDã€‚èä½¿ç”¨ UUID v7ï¼Œå› å…¶åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯ï¼Œåœ¨æ•°æ®åº“ç´¢å¼•å’Œæ—¥å¿—æ’åºä¸­æ€§èƒ½æ›´å¥½</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// äº‹ä»¶ç±»å‹ã€‚é‡‡ç”¨ç‚¹åˆ†å‘½åæ³•ï¼Œe.g., &quot;user.voice.chunk&quot;, &quot;sys.lifecycle.stop&quot;</span>
<span class="w">  </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// å‘ç”Ÿæ—¶é—´ã€‚å¿…é¡»æ˜¯ ISO 8601 UTC å­—ç¬¦ä¸²ï¼Œe.g., &quot;2023-10-27T10:00:00.123Z&quot;</span>
<span class="w">  </span><span class="c1">// åˆ‡å‹¿ä½¿ç”¨æœ¬åœ°æ—¶é—´æˆ–å•çº¯çš„ Unix Timestamp (è°ƒè¯•æ—¶éš¾ä»¥é˜…è¯»)</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// --- é€»è¾‘æ§åˆ¶åŒº ---</span>

<span class="w">  </span><span class="c1">// æ¥æºæ ‡è¯†ã€‚ç”¨äºåŒºåˆ†å¤šè·¯è¾“å…¥ï¼Œe.g., &quot;ws_connection_1&quot;, &quot;timer_system&quot;</span>
<span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// é€»è¾‘æ—¶é’Ÿ/åºåˆ—å· (å¯é€‰)ã€‚ç”¨äºåœ¨åˆ†å¸ƒå¼æˆ–ä¹±åºç½‘ç»œä¸­é‡å»ºå› æœå…³ç³»</span>
<span class="w">  </span><span class="nx">sequenceId?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// --- å…ƒæ•°æ®åŒº (Metadata) ---</span>
<span class="w">  </span><span class="c1">// å­˜æ”¾ä¸å½±å“ä¸šåŠ¡é€»è¾‘ï¼Œä½†å¯¹åŸºç¡€è®¾æ–½è‡³å…³é‡è¦çš„ä¿¡æ¯</span>
<span class="w">  </span><span class="nx">meta</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">correlationId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// é“¾è·¯è¿½è¸ª ID</span>
<span class="w">    </span><span class="nx">userId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">       </span><span class="c1">// å½’å±ç”¨æˆ·</span>
<span class="w">    </span><span class="nx">clientVersion?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// å®¢æˆ·ç«¯ç‰ˆæœ¬ (ç”¨äºå¤„ç†å…¼å®¹æ€§)</span>
<span class="w">    </span><span class="nx">retryCount?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">   </span><span class="c1">// é‡è¯•æ¬¡æ•°</span>
<span class="w">    </span><span class="nx">priority</span><span class="o">?:</span><span class="w"> </span><span class="s1">&#39;high&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;low&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// è°ƒåº¦ä¼˜å…ˆçº§</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- æ•°æ®åŒº ---</span>
<span class="w">  </span><span class="c1">// å®é™…çš„ä¸šåŠ¡è´Ÿè½½ï¼Œå¿…é¡»æ˜¯ Plain JSON Object</span>
<span class="w">  </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">T</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="212-payload">2.1.2 å…³é”® Payload å®šä¹‰è¯¦è§£</h4>
<p><strong>A. ç”¨æˆ·å¤šæ¨¡æ€è¾“å…¥ (User Input)</strong></p>
<p>å®æ—¶ Agent çš„è¾“å…¥è¿œä¸æ­¢æ–‡æœ¬ã€‚æˆ‘ä»¬éœ€è¦å¤„ç†æµå¼çš„éŸ³é¢‘ã€æ‰“æ–­ä¿¡å·ä»¥åŠéè¯­è¨€çš„ UI äº¤äº’ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ–‡æœ¬è¾“å…¥</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">TextPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">isFinal</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç”¨äºæµå¼ ASR çš„ä¸­é—´ç»“æœ (partial results)</span>
<span class="p">}</span>

<span class="c1">// éŸ³é¢‘ç‰‡æ®µ (ç”¨äº VAD å’Œ ASR)</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">AudioChunkPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pcm&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;opus&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">sampleRate</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// Base64 ç¼–ç çš„éŸ³é¢‘å¸§ï¼Œæˆ–è€…æŒ‡å‘å…±äº«å†…å­˜/S3 çš„å¼•ç”¨</span>
<span class="w">  </span><span class="nx">sequence</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="c1">// å¸§åºå·ï¼Œé˜²æ­¢ä¹±åº</span>
<span class="p">}</span>

<span class="c1">// æ„å›¾/æ§åˆ¶ä¿¡å· (Control Signals)</span>
<span class="kd">interface</span><span class="w"> </span><span class="nx">ControlPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;interrupt&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;undo&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;regenerate&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">targetEventId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// é’ˆå¯¹å“ªä¸ªä¹‹å‰çš„äº‹ä»¶è¿›è¡Œæ“ä½œ (e.g., æ‰“æ–­äº†å“ªå¥è¯)</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>B. æ¨¡å‹ç”Ÿæˆæµ (LLM Generation Stream)</strong></p>
<p>LLM è¾“å‡ºåœ¨ FRP ä¸­é€šå¸¸è¢«æ‹†è§£ä¸ºç»†ç²’åº¦çš„æµäº‹ä»¶ï¼Œä»¥ä¾¿ UI å®ç°æ‰“å­—æœºæ•ˆæœå¹¶å°½æ—©è§¦å‘å·¥å…·ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">ModelDeltaPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// å¢é‡å†…å®¹</span>
<span class="w">  </span><span class="nx">delta</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// ç´¯ç§¯å†…å®¹ (å¯é€‰ï¼Œç”¨äº UI å®¹é”™ï¼Œé˜²æ­¢ä¸¢åŒ…å¯¼è‡´ä¹±ç )</span>
<span class="w">  </span><span class="nx">accumulated?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// æ€è€ƒè¿‡ç¨‹ (é’ˆå¯¹ CoT æ¨¡å‹ï¼Œå¦‚ o1/r1)</span>
<span class="w">  </span><span class="nx">reasoningDelta?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// å½“å‰ç”ŸæˆçŠ¶æ€</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;generating&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;function_calling&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// å¦‚æœè§¦å‘äº†å·¥å…·è°ƒç”¨</span>
<span class="w">  </span><span class="nx">toolCalls</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">argumentsDelta</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// JSON ç‰‡æ®µ</span>
<span class="w">  </span><span class="p">}[];</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="b2-state-schema">B.2 State Schemaï¼šç¡®å®šæ€§çš„ç³»ç»Ÿå¿«ç…§</h3>
<p>State æ˜¯ Event æµåœ¨æ—¶é—´è½´ä¸Šçš„æŠ•å½±ã€‚å…¬å¼ï¼š<code>State(t) = Reducer(InitialState, Events[0...t])</code>ã€‚
è®¾è®¡ State çš„æ ¸å¿ƒåŸåˆ™æ˜¯ <strong>Single Source of Truthï¼ˆå•ä¸€äº‹å®æ¥æºï¼‰</strong>ã€‚</p>
<h4 id="221-the-state-tree">2.2.1 çŠ¶æ€æ ‘ç»“æ„ (The State Tree)</h4>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">AgentState</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// --- 1. é…ç½®ä¸é™æ€ä¿¡æ¯ (Config) ---</span>
<span class="w">  </span><span class="nx">config</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">agentId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;chat&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;copilot&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;background&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">modelParams</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">temp</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- 2. è®°å¿†ä¸ä¸Šä¸‹æ–‡ (Memory) ---</span>
<span class="w">  </span><span class="c1">// è¿™éƒ¨åˆ†é€šå¸¸éœ€è¦æŒä¹…åŒ–åˆ° DB</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">turnCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="kt">OpenAICompatibleMessage</span><span class="p">[];</span><span class="w"> </span><span class="c1">// å®Œæ•´çš„å¯¹è¯å†å²</span>
<span class="w">    </span><span class="nx">variables</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span><span class="w">      </span><span class="c1">// æå–å‡ºçš„å®ä½“è®°å¿† (e.g., userName=&quot;Alice&quot;)</span>
<span class="w">    </span><span class="nx">summary?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                    </span><span class="c1">// é•¿å¯¹è¯çš„æ‘˜è¦</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- 3. è¿è¡Œæ—¶ç¬æ€ (Runtime Volatile) ---</span>
<span class="w">  </span><span class="c1">// è¿™éƒ¨åˆ†ä¸¢å¤±åä¸å½±å“æ•°æ®ä¸€è‡´æ€§ï¼Œä½†å½±å“å½“å‰ä½“éªŒ</span>
<span class="w">  </span><span class="nx">runtime</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// çŠ¶æ€æœºæ ¸å¿ƒçŠ¶æ€</span>
<span class="w">    </span><span class="nx">lifecycle</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;idle&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;listening&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;thinking&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;acting&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;speaking&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å½“å‰æ­£åœ¨ç§¯ç´¯çš„è¾“å…¥ (æ¯”å¦‚ç”¨æˆ·æ­£åœ¨è¯´è¯ï¼ŒVAD å°šæœªæˆªæ­¢)</span>
<span class="w">    </span><span class="nx">inputBuffer</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">transcript</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">audioEnergy</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"> </span><span class="c1">// ç”¨äº UI ç»˜åˆ¶æ³¢å½¢</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// å½“å‰ LLM æ­£åœ¨ç”Ÿæˆçš„è‰ç¨¿</span>
<span class="w">    </span><span class="nx">outputBuffer</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">currentToolCall</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// å¾…å¤„ç†çš„å‰¯ä½œç”¨ (Pending Effects)</span>
<span class="w">    </span><span class="c1">// è®°å½•å‘å‡ºäº†å“ªäº›è¯·æ±‚ä½†è¿˜æ²¡æ”¶åˆ°å›æ‰§ï¼Œç”¨äºå¤„ç†è¶…æ—¶å’Œå–æ¶ˆ</span>
<span class="w">    </span><span class="nx">pendingEffects</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;tool&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;retrieval&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">startedAt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">timeoutAt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- 4. è¯Šæ–­ä¸é¢„ç®— (Diagnostics) ---</span>
<span class="w">  </span><span class="nx">diagnostics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">lastError</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">msg</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="nx">tokenUsage</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">sessionTotal</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">lastTurn</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">      </span><span class="nx">budgetRemaining</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="nx">latency</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">lastP99</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="ascii">ASCII å›¾è§£ï¼šçŠ¶æ€çš„å±‚çº§</h4>
<div class="codehilite"><pre><span></span><code>Root State
â”œâ”€â”€ Config (Read-onlyish)
â”‚   â””â”€â”€ &quot;Mode: Strict&quot;
â”œâ”€â”€ Context (Persistent)
â”‚   â”œâ”€â”€ Msg[0]: User &quot;Hi&quot;
â”‚   â”œâ”€â”€ Msg[1]: Bot &quot;Hello&quot;
â”‚   â””â”€â”€ Vars: { &quot;city&quot;: &quot;Beijing&quot; }
â””â”€â”€ Runtime (Transient)
    â”œâ”€â”€ Lifecycle: &quot;Thinking&quot;
    â”œâ”€â”€ InputBuffer: (empty)
    â””â”€â”€ PendingEffects
        â””â”€â”€ Tool: &quot;WeatherAPI&quot; (id: req_123, status: sent)
</code></pre></div>

<hr />
<h3 id="b3-toolreceipt-schema">B.3 ToolReceipt Schemaï¼šåŒé‡è§†å›¾åè®®</h3>
<p>è¿™æ˜¯æ„å»º <strong>Agentic UI</strong> çš„å…³é”®ã€‚Tool/API çš„è¿”å›å€¼ä¸èƒ½åªæ˜¯ç»™ LLM çœ‹çš„å­—ç¬¦ä¸²ï¼Œå¿…é¡»åŒ…å«ç»™ UI æ¸²æŸ“ç”¨çš„ç»“æ„åŒ–æ•°æ®ã€‚</p>
<h4 id="231-receipt">2.3.1 Receipt ç»“æ„è®¾è®¡</h4>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">ToolReceipt</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// --- å…³è”ä¿¡æ¯ ---</span>
<span class="w">  </span><span class="nx">callId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">        </span><span class="c1">// å¯¹åº” LLM tool_call çš„ ID</span>
<span class="w">  </span><span class="nx">toolName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">      </span><span class="c1">// å·¥å…·åç§°</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">     </span><span class="c1">// æ‰§è¡Œå®Œæˆæ—¶é—´</span>

<span class="w">  </span><span class="c1">// --- æ‰§è¡Œç»“æœçŠ¶æ€ ---</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;timeout&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;skipped&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// --- è§†å›¾ 1: ç»™ LLM çœ‹ (Compact View) ---</span>
<span class="w">  </span><span class="c1">// ç›®æ ‡ï¼šæœ€å°åŒ– Token æ¶ˆè€—ï¼Œä¼ é€’æ ¸å¿ƒé€»è¾‘äº‹å®</span>
<span class="w">  </span><span class="c1">// ç¤ºä¾‹: &quot;Stock AAPL is 150.00 (+1.2%)&quot;</span>
<span class="w">  </span><span class="nx">systemContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// --- è§†å›¾ 2: ç»™ç”¨æˆ·çœ‹ (Rich View) ---</span>
<span class="w">  </span><span class="c1">// ç›®æ ‡ï¼šæä¾›æœ€ä½³äº¤äº’ä½“éªŒï¼Œç”± UI ç»„ä»¶åº“è§£æ</span>
<span class="w">  </span><span class="c1">// ç¤ºä¾‹: { type: &quot;stock_card&quot;, data: { symbol: &quot;AAPL&quot;, chart: [...] } }</span>
<span class="w">  </span><span class="nx">uiContent</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">viewType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">    </span><span class="c1">// å‰ç«¯æ ¹æ®æ­¤å­—æ®µé€‰æ‹©ç»„ä»¶</span>
<span class="w">    </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">payload</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span><span class="w">        </span><span class="c1">// å…·ä½“çš„ JSON æ•°æ®</span>
<span class="w">    </span><span class="nx">interactions</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="c1">// å…è®¸ç”¨æˆ·ç›´æ¥åœ¨ç»“æœä¸Šæ“ä½œ</span>
<span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">      </span><span class="nx">actionId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç‚¹å‡»åè§¦å‘æ–°çš„ Event</span>
<span class="w">    </span><span class="p">}[];</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- è§†å›¾ 3: ç»™å¼€å‘è€…çœ‹ (Debug View) ---</span>
<span class="w">  </span><span class="nx">debugInfo</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">rawRequest</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span><span class="w">     </span><span class="c1">// åŸå§‹ HTTP è¯·æ±‚</span>
<span class="w">    </span><span class="nx">rawResponse</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span><span class="w">    </span><span class="c1">// åŸå§‹ HTTP å“åº”</span>
<span class="w">    </span><span class="nx">latencyMs</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">costCurrency</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="c1">// --- é”™è¯¯è¯¦æƒ… (å½“ status != success) ---</span>
<span class="w">  </span><span class="nx">error</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">        </span><span class="c1">// e.g., &quot;rate_limit_exceeded&quot;</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">     </span><span class="c1">// äººç±»å¯è¯»</span>
<span class="w">    </span><span class="nx">isRetryable</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ˜¯å¦å»ºè®® Agent é‡è¯•</span>
<span class="w">    </span><span class="nx">suggestion?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç»™ LLM çš„ä¿®å¤å»ºè®®</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h3 id="b4-trace-schema">B.4 Trace Schemaï¼šå¼‚æ­¥å› æœé“¾</h3>
<p>åœ¨æµå¼ç³»ç»Ÿä¸­ï¼Œ<code>Function A</code> è°ƒç”¨ <code>Function B</code> çš„ä¼ ç»Ÿå †æ ˆå¹¶ä¸å­˜åœ¨ã€‚å­˜åœ¨çš„æ˜¯ <code>Event A</code> è§¦å‘äº† <code>Effect B</code>ï¼Œ<code>Effect B</code> äº§ç”Ÿäº† <code>Event C</code>ã€‚æˆ‘ä»¬éœ€è¦è®°å½•è¿™ç§<strong>å› æœé“¾ï¼ˆCausalityï¼‰</strong>ã€‚</p>
<h4 id="241-span-link">2.4.1 Span ä¸ Link</h4>
<p>åŸºäº OpenTelemetry è¯­ä¹‰çš„ç®€åŒ–ç‰ˆï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">TraceSpan</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">traceId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">       </span><span class="c1">// å…¨å±€ä¼šè¯ ID</span>
<span class="w">  </span><span class="nx">spanId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">        </span><span class="c1">// å½“å‰æ“ä½œ ID</span>
<span class="w">  </span><span class="nx">parentSpanId?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// çˆ¶æ“ä½œ ID</span>

<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">          </span><span class="c1">// e.g., &quot;executor.run_tool&quot;</span>
<span class="w">  </span><span class="nx">kind</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;PRODUCER&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;CONSUMER&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;INTERNAL&#39;</span><span class="p">;</span>

<span class="w">  </span><span class="nx">startTime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">endTime?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// å…³é”®ï¼šå°† Trace ä¸ Event ç»‘å®š</span>
<span class="w">  </span><span class="nx">links</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">triggerEventId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// å“ªä¸ª Event å¼€å¯äº†è¿™ä¸ª Span</span>
<span class="w">    </span><span class="nx">resultEventIds</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span><span class="w"> </span><span class="c1">// è¿™ä¸ª Span äº§å‡ºäº†å“ªäº› Event</span>
<span class="w">  </span><span class="p">}[];</span>

<span class="w">  </span><span class="c1">// å±æ€§ä¸æŒ‡æ ‡</span>
<span class="w">  </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;llm.model&quot;</span><span class="nx">?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="s2">&quot;llm.input_tokens&quot;</span><span class="nx">?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="s2">&quot;tool.name&quot;</span><span class="nx">?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="s2">&quot;error.type&quot;</span><span class="nx">?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="3">3. æœ¬ç« å°ç»“</h2>
<ul>
<li><strong>åè®®å…ˆè¡Œ</strong>ï¼šåœ¨å†™ä¸€è¡Œä»£ç ä¹‹å‰ï¼Œå…ˆç¡®å®š Event å’Œ State çš„ JSON Schemaã€‚</li>
<li><strong>ä¿¡å°æ¨¡å¼</strong>ï¼šä½¿ç”¨ç»Ÿä¸€çš„ Event Envelopeï¼ŒåŒ…å« <code>id</code>, <code>type</code>, <code>timestamp</code>, <code>meta</code>ï¼Œå°†ä¸šåŠ¡æ•°æ®éš”ç¦»åœ¨ <code>payload</code> ä¸­ã€‚</li>
<li><strong>çŠ¶æ€åˆ†ç¦»</strong>ï¼šåŒºåˆ†æŒä¹…åŒ–çš„ <code>Context</code>ï¼ˆå­˜ DBï¼‰å’Œç¬æ€ <code>Runtime</code>ï¼ˆå­˜å†…å­˜/Redisï¼‰ï¼Œé¿å…ä¸å¿…è¦çš„ I/O å¼€é”€ã€‚</li>
<li><strong>å›æ‰§åˆ†å±‚</strong>ï¼šToolReceipt å¿…é¡»æ˜ç¡®åŒºåˆ† <code>systemContent</code>ï¼ˆç»™ AI çœ Tokenï¼‰å’Œ <code>uiContent</code>ï¼ˆç»™äººç±»çœ‹æ•ˆæœï¼‰ã€‚</li>
<li><strong>ä¸å¯å˜æ€§</strong>ï¼šEvent æ˜¯å†å²äº‹å®ï¼Œä¸å¯å˜æ›´ï¼›State æ˜¯è¡ç”Ÿç»“æœï¼Œå¯éšæ—¶é‡ç®—ã€‚</li>
</ul>
<hr />
<h2 id="4">4. ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>JSON è®¾è®¡</strong>ï¼šè¯·è®¾è®¡ä¸€ä¸ª <code>TimerEvent</code> çš„ Payloadï¼Œç”¨äºè§¦å‘ Agent çš„å®šæ—¶ä»»åŠ¡ï¼ˆæ¯”å¦‚æ¯ 5 åˆ†é’Ÿæé†’ä¸€æ¬¡ï¼‰ã€‚éœ€è¦åŒ…å«å“ªäº›å­—æ®µæ¥é˜²æ­¢ä»»åŠ¡å †ç§¯ï¼Ÿ</li>
<li><strong>State æ‹†è§£</strong>ï¼šå¦‚æœ Agent æ”¯æŒâ€œç”¨æˆ·æ­£åœ¨è¾“å…¥æ—¶å±•ç¤ºæ³¢å½¢åŠ¨ç”»â€ï¼Œè¿™ä¸ªæ³¢å½¢çš„æŒ¯å¹…æ•°æ®ï¼ˆ<code>amplitude</code>ï¼‰åº”è¯¥æ”¾åœ¨ <code>AgentState</code> çš„å“ªä¸ªéƒ¨åˆ†ï¼Ÿä¸ºä»€ä¹ˆä¸åº”è¯¥æ”¾åœ¨ <code>Context</code> é‡Œï¼Ÿ</li>
<li><strong>Receipt è½¬æ¢</strong>ï¼šä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„å·¥å…·è¿”å›äº† 100 æ¡ SQL è®°å½•ã€‚è¯·å†™å‡ºå®ƒçš„ <code>ToolReceipt</code>ï¼Œè¦æ±‚ <code>systemContent</code> åªåŒ…å«å‰ 3 æ¡æ‘˜è¦ï¼Œè€Œ <code>uiContent</code> åŒ…å«åˆ†é¡µæµè§ˆæ‰€éœ€çš„æ•°æ®ã€‚</li>
</ol>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<ol start="4">
<li><strong>Schema æ¼”è¿›ä¸å‘åå…¼å®¹</strong>ï¼š<ul>
<li>åœºæ™¯ï¼šç³»ç»Ÿä¸Šçº¿åŠå¹´åï¼Œä½ éœ€è¦å°† <code>ToolReceipt</code> ä¸­çš„ <code>uiContent</code> å­—æ®µä»ç®€å•çš„ JSON å¯¹è±¡æ”¹ä¸ºæ”¯æŒå¤š Tab çš„æ•°ç»„ç»“æ„ <code>uiTabs: []</code>ã€‚</li>
<li>é—®é¢˜ï¼šå¦‚ä½•ä¿®æ”¹ Schema å®šä¹‰ï¼Œä½¿å¾—æ—§ç‰ˆæœ¬çš„æ—¥å¿—ï¼ˆåŒ…å« <code>uiContent</code>ï¼‰åœ¨å›æ”¾ï¼ˆReplayï¼‰æ—¶ä»ç„¶èƒ½è¢«æ–°ç‰ˆä»£ç æ­£ç¡®å¤„ç†ï¼Ÿè¯·ç»™å‡ºâ€œUpcastingï¼ˆå‘ä¸Šè½¬å‹ï¼‰â€çš„ä¼ªä»£ç é€»è¾‘ã€‚</li>
</ul>
</li>
<li><strong>éšç§ä¸å®¡è®¡</strong>ï¼š<ul>
<li>åœºæ™¯ï¼šä½ çš„ Agent è¢«éƒ¨ç½²åœ¨åŒ»ç–—åœºæ™¯ï¼Œæ‰€æœ‰ <code>Event</code> éƒ½ä¼šè¢«æŒä¹…åŒ–ã€‚</li>
<li>é—®é¢˜ï¼šå¦‚ä½•åœ¨ Schema å±‚é¢è®¾è®¡ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—æˆ‘ä»¬æ—¢èƒ½ä¿ç•™ Debug æ‰€éœ€çš„é“¾è·¯ä¿¡æ¯ï¼ˆå¦‚å‘ç”Ÿé”™è¯¯çš„å·¥å…·å‚æ•°ï¼‰ï¼Œåˆèƒ½ç¡®ä¿ä¸å­˜å‚¨ç”¨æˆ·çš„ PIIï¼ˆæ•æ„Ÿä¸ªäººä¿¡æ¯ï¼Œå¦‚ç—…å†å·ã€å§“åï¼‰ï¼Ÿæç¤ºï¼šè€ƒè™‘ Crypto-shredding æˆ–å½±å­å­—æ®µã€‚</li>
</ul>
</li>
</ol>
<hr />
<h3 id="_3">å‚è€ƒç­”æ¡ˆ</h3>
<details>
<summary><strong>ç‚¹å‡»å±•å¼€å‚è€ƒç­”æ¡ˆ</strong></summary>
<h4 id="_4">åŸºç¡€é¢˜</h4>
<ol>
<li><strong>TimerEvent è®¾è®¡</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">TimerPayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">taskId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">        </span><span class="c1">// ä»»åŠ¡å®šä¹‰çš„å”¯ä¸€æ ‡è¯†</span>
<span class="w">  </span><span class="nx">scheduledTime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="c1">// è®¡åˆ’æ‰§è¡Œæ—¶é—´</span>
<span class="w">  </span><span class="nx">actualTime</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">    </span><span class="c1">// å®é™…è§¦å‘æ—¶é—´</span>
<span class="w">  </span><span class="nx">missedTicks</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">   </span><span class="c1">// å¦‚æœç³»ç»Ÿå¡é¡¿ï¼Œé”™è¿‡äº†å¤šå°‘æ¬¡ tick (ç”¨äºèƒŒå‹å¤„ç†)</span>
<span class="w">  </span><span class="nx">isRecurring</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="w">   </span><span class="o">*</span><span class="n">Hint</span><span class="o">*:</span><span class="w"> </span><span class="n n-Quoted">`missedTicks`</span><span class="w"> </span><span class="n">å¾ˆé‡è¦ï¼Œå¦‚æœç§¯å‹å¤ªå¤šï¼Œç­–ç•¥å±‚å¯ä»¥é€‰æ‹©ä¸¢å¼ƒæˆ–åˆå¹¶æ‰§è¡Œã€‚</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>æ³¢å½¢æ•°æ®ä½ç½®</strong>ï¼š</p>
<ul>
<li><strong>ä½ç½®</strong>ï¼š<code>state.runtime.inputBuffer</code> æˆ–å•ç‹¬çš„ <code>state.ui.ephemeral</code>ã€‚</li>
<li><strong>åŸå› </strong>ï¼šè¿™æ˜¯é«˜é¢‘ã€æ˜“å˜ã€æ— ä¸šåŠ¡å«ä¹‰çš„æ•°æ®ã€‚æ”¾å…¥ <code>Context</code> ä¼šå¯¼è‡´æ•°æ®åº“å†™å…¥çˆ†ç‚¸ï¼Œä¸”è¯¥æ•°æ®åœ¨ä¼šè¯ç»“æŸåæ— ä»·å€¼ã€‚ç”šè‡³å¯ä»¥ä¸è¿›ä¸» Stateï¼Œç›´æ¥ç”±å‰ç«¯å¤„ç†ï¼Œé™¤éåç«¯éœ€è¦åŸºäºéŸ³é‡åš VAD é€»è¾‘ã€‚</li>
</ul>
</li>
<li>
<p><strong>DB æŸ¥è¯¢ Receipt</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;toolName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;query_users&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;systemContent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Found 100 users. Top 3: Alice, Bob, Charlie. (Data truncated, ask specifically to filter)&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;uiContent&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;viewType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;data_table&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;payload&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;columns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;role&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;rows&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">...</span><span class="mi">100</span><span class="w"> </span><span class="err">records...</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="c1">// å‰ç«¯è´Ÿè´£åˆ†é¡µ</span>
<span class="w">      </span><span class="nt">&quot;pageSize&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_5">æŒ‘æˆ˜é¢˜</h4>
<ol start="4">
<li><strong>Schema æ¼”è¿› (Upcasting)</strong>ï¼š<ul>
<li><strong>æ€è·¯</strong>ï¼šåœ¨æ•°æ®è¿›å…¥ Reducer ä¹‹å‰ï¼Œé€šè¿‡ä¸€ä¸ª <code>Upcaster</code> å±‚å°†æ—§æ•°æ®æ ‡å‡†åŒ–ä¸ºæ–°æ•°æ®ã€‚</li>
<li><strong>ä¼ªä»£ç </strong>ï¼š</li>
</ul>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">upcastEvent</span><span class="p">(</span><span class="nx">rawEvent</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">AgentEvent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// å‡è®¾æ—§ç‰ˆ schemaVersion ä¸º 1 æˆ– undefined</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">v</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rawEvent</span><span class="p">.</span><span class="kr">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;tool.result&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">uiContent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// è¿ç§»é€»è¾‘ï¼šæŠŠæ—§çš„å•ä¸€å¯¹è±¡åŒ…è¿›æ–°çš„ Tabs æ•°ç»„</span>
<span class="w">      </span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">uiTabs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Result&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">rawEvent.payload.uiContent</span>
<span class="w">      </span><span class="p">}];</span>
<span class="w">      </span><span class="ow">delete</span><span class="w"> </span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">uiContent</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">rawEvent</span><span class="p">.</span><span class="nx">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ ‡è®°å‡çº§å®Œæˆ</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">rawEvent</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ol start="5">
<li><strong>éšç§ä¿æŠ¤ Schema</strong>ï¼š<ul>
<li><strong>æ–¹æ¡ˆ</strong>ï¼šåœ¨ Schema ä¸­åˆ†ç¦» <code>Data</code> å’Œ <code>References</code>ã€‚æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨åœ¨ä¸“ç”¨ Vaultï¼Œæ—¥å¿—ä¸­åªå­˜æŒ‡é’ˆã€‚</li>
<li><strong>Schema ç¤ºä¾‹</strong>ï¼š</li>
</ul>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nx">SensitivePayload</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// åŸå§‹å­—æ®µï¼ˆåœ¨è½ç›˜æ—¥å¿—å‰è¢«æ“¦é™¤/å“ˆå¸ŒåŒ–ï¼‰</span>
<span class="w">  </span><span class="nx">userInput?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// è„±æ•åçš„ç”¨äºåˆ†æçš„ç‰¹å¾</span>
<span class="w">  </span><span class="nx">msgLength</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">intentCategory</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// æŒ‡å‘åŠ å¯†ä¿é™©ç®±çš„å¼•ç”¨ (ä»…ä¾›æœ€é«˜æƒé™ Debug ä½¿ç”¨)</span>
<span class="w">  </span><span class="nx">secureRef</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;vault://users/123/logs/abc-xyz&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">*</span><span class="w">   </span><span class="o">*</span><span class="n">æœºåˆ¶</span><span class="o">*</span><span class="n">ï¼šLogger</span><span class="w"> </span><span class="n">ä¸­é—´ä»¶åœ¨åºåˆ—åŒ–å‰ï¼Œæ£€æµ‹</span><span class="w"> </span><span class="n">PII</span><span class="w"> </span><span class="n">å­—æ®µï¼Œå°†å…¶æ›¿æ¢ä¸º</span><span class="w"> </span><span class="n n-Quoted">`***`</span><span class="w"> </span><span class="n">æˆ–ç”Ÿæˆ</span><span class="w"> </span><span class="n n-Quoted">`secureRef`</span><span class="n">ï¼Œç¡®ä¿æ™®é€šæ—¥å¿—æ–‡ä»¶ä¸­ä¸å«æ˜æ–‡ã€‚</span>
</code></pre></div>

</details>
<hr />
<h2 id="5-gotchas">5. å¸¸è§é™·é˜±ä¸é”™è¯¯ (Gotchas)</h2>
<h3 id="51-fat-event">5.1 "Fat Event" ç»¼åˆç—‡</h3>
<ul>
<li><strong>é”™è¯¯</strong>ï¼šåœ¨ <code>Event</code> ä¸­æºå¸¦å·¨å¤§çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚ 10MB çš„ PDF æ–‡ä»¶å†…å®¹ï¼‰ã€‚</li>
<li><strong>åæœ</strong>ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–é˜»å¡ä¸»çº¿ç¨‹ï¼Œç½‘ç»œå¸¦å®½è€—å°½ï¼Œæ—¥å¿—å­˜å‚¨æˆæœ¬æ¿€å¢ã€‚</li>
<li><strong>Rule of Thumb</strong>ï¼š<strong>Payload åº”è¯¥åªåŒ…å«å…ƒæ•°æ®å’Œå¼•ç”¨</strong>ã€‚æ–‡ä»¶å†…å®¹åº”ä¸Šä¼ åˆ° S3/Blob Storageï¼ŒEvent ä¸­åªä¼  <code>fileUrl</code> æˆ– <code>blobId</code>ã€‚</li>
</ul>
<h3 id="52-ui-state-business-state">5.2 æ··æ·† UI State ä¸ Business State</h3>
<ul>
<li><strong>é”™è¯¯</strong>ï¼šåœ¨ <code>AgentState</code> ä¸­å­˜å‚¨ <code>isMenuOpen: boolean</code> æˆ– <code>hoverIndex: number</code>ã€‚</li>
<li><strong>åæœ</strong>ï¼šåç«¯é€»è¾‘è¢«å‰ç«¯äº¤äº’ç»†èŠ‚æ±¡æŸ“ã€‚å½“ä» Web è¿ç§»åˆ° è¯­éŸ³åŠ©æ‰‹ï¼ˆæ— å±å¹•ï¼‰æ—¶ï¼Œè¿™äº›çŠ¶æ€å˜å¾—æ¯«æ— æ„ä¹‰ä¸”éš¾ä»¥ç»´æŠ¤ã€‚</li>
<li><strong>ä¿®æ­£</strong>ï¼š<code>AgentState</code> åªå­˜å‚¨<strong>ä¸šåŠ¡æ„å›¾</strong>ï¼ˆå¦‚ <code>recommendedActions</code> åˆ—è¡¨ï¼‰ã€‚èœå•æ˜¯å¦æ‰“å¼€æ˜¯å‰ç«¯ View Model çš„äº‹ï¼Œä¸è¦ä¼ å›ç»™ Agentã€‚</li>
</ul>
<h3 id="53">5.3 ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡</h3>
<ul>
<li><strong>é”™è¯¯</strong>ï¼š<code>state.dbConnection = new MongoClient(...)</code> æˆ– <code>event.callback = () =&gt; { ... }</code>ã€‚</li>
<li><strong>åæœ</strong>ï¼šæ— æ³•ä¿å­˜å¿«ç…§ï¼Œæ— æ³•é€šè¿‡ç½‘ç»œä¼ è¾“ Stateï¼ŒTime Travel Debugging å¤±æ•ˆã€‚</li>
<li><strong>ä¿®æ­£</strong>ï¼šState ä¸­åªå­˜ <code>connectionStatus: 'connected'</code>ã€‚å…·ä½“çš„è¿æ¥å®ä¾‹ç”± Runtime çš„ <code>EffectManager</code> åœ¨é—­åŒ…ä¸­ç»´æŠ¤ï¼Œä¸æš´éœ²ç»™çº¯é€»è¾‘å±‚ã€‚</li>
</ul>
<h3 id="54-versioning">5.4 ç¼ºä¹ç‰ˆæœ¬å· (Versioning)</h3>
<ul>
<li><strong>é”™è¯¯</strong>ï¼šç›´æ¥ä¿®æ”¹ Event ç»“æ„è€Œä¸åŠ  <code>version</code> å­—æ®µã€‚</li>
<li><strong>åæœ</strong>ï¼šä¸Šçº¿æ–°ç‰ˆåï¼Œæ—§çš„å®¢æˆ·ç«¯å‘æ¥çš„äº‹ä»¶å¯¼è‡´åç«¯ Crashï¼›æˆ–è€…å›æ”¾æ—§æ—¥å¿—æ—¶æŠ¥é”™ã€‚</li>
<li><strong>Rule of Thumb</strong>ï¼šæ‰€æœ‰æŒä¹…åŒ–çš„æ•°æ®ç»“æ„ï¼ˆState/Eventï¼‰éƒ½åº”åŒ…å« <code>schemaVersion</code> å­—æ®µã€‚</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter18.html" class="nav-link prev">â† Appendix Aï½œæœ¯è¯­è¡¨ & FRP ç®—å­é€ŸæŸ¥ (The Agent Developer's Rosetta Stone)</a><a href="chapter20.html" class="nav-link next">Appendix Cï½œæµ‹è¯•æ–¹æ³•ï¼šè™šæ—¶é—´ã€å›æ”¾ä¸æ··æ²Œå·¥ç¨‹ â†’</a></nav>
        </main>
    </div>
</body>
</html>